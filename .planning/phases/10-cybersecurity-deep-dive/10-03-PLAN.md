---
phase: 10-cybersecurity-deep-dive
plan: 03
type: execute
wave: 3
depends_on: ["10-01"]
files_modified:
  - veritas/analysis/security/pci_dss.py
  - veritas/analysis/security/gdpr.py
autonomous: true
requirements:
  - SEC-01
user_setup: []

must_haves:
  truths:
    - PCI DSS module implements 5 compliance checks for payment security
    - GDPR module implements 5 compliance checks for data protection
    - Both modules analyze DOM metadata and HTTP headers for compliance violations
    - Findings map to CWE IDs appropriate for each compliance standard
    - CVSS scores calculated for severity classification
  artifacts:
    - path: veritas/analysis/security/pci_dss.py
      provides: PCI DSS compliance checking (3.3, 3.4, 4.1, 6.5, 8.2)
      tier: MEDIUM
      exports: ["PCIDSSComplianceModule"]
    - path: veritas/analysis/security/gdpr.py
      provides: GDPR compliance checking (Art. 7, 17, 25, 32, 35)
      tier: MEDIUM
      exports: ["GDPRComplianceModule"]
  key_links:
    - from: veritas/analysis/security/pci_dss.py
      to: veritas/analysis/security/base.py
      via: import SecurityModule
      pattern: "from .base import SecurityModule"
    - from: veritas/analysis/security/gdpr.py
      to: veritas/analysis/security/base.py
      via: import SecurityModule
      pattern: "from .base import SecurityModule"
    - from: veritas/analysis/security/pci_dss.py
      to: veritas/analysis/dom_analyzer.py
      via: import DOMAnalyzer
      pattern: "from analysis.dom_analyzer import DOMAnalyzer"
---

<objective>
Implement PCI DSS and GDPR compliance security modules with tier-based execution, covering payment card security standards (PCI DSS 3.2.1) and data protection regulations (GDPR Art. 7, 17, 25, 32, 35).

Purpose: Provide PCI DSS and GDPR compliance coverage by implementing detection modules that analyze forms, headers, and page content for payment security and data protection violations, mapped to CWE IDs with CVSS severity scoring.

Output: 2 compliance security modules (PCIDSSComplianceModule, GDPRComplianceModule), both MEDIUM tier, each extending SecurityModule with findings for specific PCI DSS and GDPR requirements.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@planning/phases/10-cybersecurity-deep-dive/10-RESEARCH.md
@planning/phases/10-cybersecurity-deep-dive/10-01-PLAN.md
@veritas/analysis/security/base.py
@veritas/analysis/dom_analyzer.py
@veritas/analysis/form_validator.py

# PCI DSS Requirements (3.2.1)

- 3.3: Mask PAN when displayed (show only last 4 digits)
- 3.4: Render PAN unreadable when stored (encrypt at rest)
- 4.1: Encrypt transmission of cardholder data over open networks (HTTPS)
- 6.5.1: SQL injection protection
- 6.5.3: Broken authentication
- 8.2: Strong authentication (complexity, expiration)

# GDPR Articles

- Art. 7: Consent (must be freely given, specific, informed, unambiguous)
- Art. 17: Right to erasure (data deletion request mechanism)
- Art. 25: Privacy by design and by default
- Art. 32: Security of processing (encryption, access controls)
- Art. 35: Data protection impact assessment (DPIA) for high-risk processing

# Form validation infrastructure

From veritas/analysis/form_validator.py:
```python
class FormActionValidator:
    def analyze(self, forms: List[dict], url: str) -> FormValidationResult
    # Validates form actions for cross-domain, HTTPS, etc.
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PCI DSS compliance module</name>
  <files>veritas/analysis/security/pci_dss.py</files>
  <action>
    Create PCIDSSComplianceModule:

    - Module: PCIDSSComplianceModule
    - Tier: MEDIUM, timeout: 12
    - Category: pci_dss

    Analyze dom_meta (forms, page_content) for PCI DSS 3.2.1 requirements:

    1. PCI DSS Req 3.3: Mask PAN when displayed
       - Pattern: Credit card numbers shown without masking
       - Search patterns: r'\d{4}[- ]?\d{4}[- ]?\d{4}[- ]?\d{4}', r'\d{16}'
       - If pattern matches and not masked (last 4 only: **** **** **** 1234)
       - Finding: pattern_type="pan_exposed_unmasked", severity="high", cwe_id="CWE-359" (Exposure of Private Personal Information)
       - Confidence: 0.70 if credit card form elements present

    2. PCI DSS Req 3.4: Encrypt PAN at rest
       - Pattern: Forms asking for full credit card number without indicating encryption
       - Search: <input type="text" name="cc">, <input type="text" name="card"> without data-encrypt or aria-label
       - Finding: pattern_type="pan_stored_unencrypted", severity="high", cwe_id="CWE-311" (Missing Encryption of Sensitive Data)
       - Confidence: 0.60

    3. PCI DSS Req 4.1: Encrypt transmission over open networks
       - Pattern: Payment forms over HTTP (not HTTPS)
       - Search: forms with action starting with http:// (not https://)
       - Finding: pattern_type="payment_over_http", severity="critical", cwe_id="CWE-319" (Cleartext Transmission)
       - Confidence: 0.90

    4. PCI DSS Req 6.5.1: SQL injection protection
       - Pattern: Payment-related forms without input validation indicators
       - Search: inputs related to cc, card, payment with no pattern/validation attributes
       - Finding: pattern_type="sql_injection_risk_payment", severity="critical", cwe_id="CWE-89" (SQL Injection)
       - Confidence: 0.50 (use OWASP A03 for confirm)

    5. PCI DSS Req 8.2: Strong authentication
       - Pattern: Payment flows with weak password requirements
       - Search: passwords without minlength, pattern, autocomplete="new-password"
       - Finding: pattern_type="weak_auth_payment", severity="medium", cwe_id="CWE-521" (Weak Password Requirements)
       - Confidence: 0.60

    Module must:
   - Extend SecurityModule from .base
   - Use DOMAnalyzer for form extraction
   - Use cwemapper from config.security_rules for CWE mapping
   - Only report PCI DSS findings if payment-related forms detected
  </action>
  <verify>
    <automated>python -c "from veritas.analysis.security.pci_dss import PCIDSSComplianceModule; m = PCIDSSComplianceModule(); print(f'{m.category_id}, tier: {m.tier}, timeout: {m.timeout}')"</automated>
  </verify>
  <done>PCI DSS compliance module implemented with 5 requirement checks (3.3, 3.4, 4.1, 6.5.1, 8.2) and CWE ID mapping</done>
</task>

<task type="auto">
  <name>Task 2: Implement GDPR compliance module</name>
  <files>veritas/analysis/security/gdpr.py</files>
  <action>
    Create GDPRComplianceModule:

    - Module: GDPRComplianceModule
    - Tier: MEDIUM, timeout: 12
    - Category: gdpr

    Analyze dom_meta (forms, page_content, meta tags) for GDPR Articles:

    1. GDPR Art. 7: Consent requirements
       - Pattern: Forms collecting data without explicit consent checkbox
       - Search: data collection forms (email, name, phone) without required consent checkbox
       - Search patterns: <input type="checkbox" name="consent">, <input type="required" name="agree">
       - Finding: pattern_type="gdpr_article7_no_consent", severity="medium", cwe_id="CWE-359" (Exposure of Private Data)
       - Evidence: "Data collection forms detected without explicit consent mechanism"
       - Recommendation: "Add required consent checkbox with clear disclosure of data processing"
       - Confidence: 0.70

    2. GDPR Art. 17: Right to erasure (data deletion)
       - Pattern: No data deletion/account deletion mechanism visible
       - Search: account settings, delete account, data export, unsubscribe links
       - If no delete account found and user account forms present
       - Finding: pattern_type="gdpr_article17_no_deletion", severity="low", cwe_id="CWE-200" (Exposure of Sensitive Info)
       - Evidence: "User account forms present but no deletion mechanism found"
       - Recommendation: "Provide data deletion request mechanism (Right to be Forgotten)"
       - Confidence: 0.50

    3. GDPR Art. 25: Privacy by design and by default
       - Pattern: Forms with pre-checked consent checkboxes
       - Search: <input type="checkbox" checked> for consent/marketing
       - Finding: pattern_type="gdpr_article25_prechecked_consent", severity="medium", cwe_id="CWE-359"
       - Evidence: "Pre-checked consent options detected (not privacy by default)"
       - Recommendation: "Uncheck consent options by default, require explicit user opt-in"
       - Confidence: 0.80

    4. GDPR Art. 32: Security of processing
       - Pattern: Missing security headers for data protection
       - Search headers: Strict-Transport-Security, Content-Security-Policy, X-Frame-Options
       - If multiple missing and data collection forms present
       - Finding: pattern_type="gdpr_article32_insufficient_security", severity="medium", cwe_id="CWE-319"
       - Evidence: "Data collection present but critical security headers missing"
       - Recommendation: "Implement HTTPS, HSTS, CSP for data in transit protection"
       - Confidence: 0.60

    5. GDPR Art. 35: Data Protection Impact Assessment (DPIA)
       - Pattern: High-risk data processing without DPIA indicators
       - Search: sensitive data (health, financial, biometric, criminal) without privacy policy link
       - Pattern keywords: health, medical, financial, credit, biometric, criminal, religion
       - If found and no privacy policy link visible
       - Finding: pattern_type="gdpr_article35_no_dpia", severity="medium", cwe_id="CWE-200"
       - Evidence: "High-risk data processing detected without DPIA/privacy policy indicator"
       - Recommendation: "Conduct DPIA for high-risk processing, publish privacy policy"
       - Confidence: 0.50

    Module must:
   - Extend SecurityModule from .base
   - Use DOMAnalyzer for form and meta tag extraction
   - Use cwemapper for CWE mapping
   - Check for data collection indicators before reporting GDP
   - Only report GDPR findings if data collection is detected
  </action>
  <verify>
    <automated>python -c "from veritas.analysis.security.gdpr import GDPRComplianceModule; m = GDPRComplianceModule(); print(f'{m.category_id}, tier: {m.tier}, timeout: {m.timeout}')"</automated>
  </verify>
  <done>GDPR compliance module implemented with 5 article checks (7, 17, 25, 32, 35) and CWE ID mapping</done>
</task>

</tasks>

<verification>
Both PCI DSS and GDPR modules auto-discoverable via get_all_security_modules(), modules only report compliance findings when relevant forms/data collection detected, CWE IDs mapped appropriately for each compliance standard
</verification>

<success_criteria>
- PCIDSSComplianceModule extends SecurityModule, category_id="pci_dss", tier=MEDIUM, timeout=12
- GDPRComplianceModule extends SecurityModule, category_id="gdpr", tier=MEDIUM, timeout=12
- PCI DSS module checks Req 3.3: PAN masking (search for credit card patterns)
- PCI DSS module checks Req 3.4: PAN encryption at rest (forms without encryption indicator)
- PCI DSS module checks Req 4.1: HTTPS transmission (payment forms over HTTP)
- PCI DSS module checks Req 6.5.1: SQL injection protection (weak input validation)
- PCI DSS module checks Req 8.2: Strong authentication (weak password requirements)
- GDPR module checks Art. 7: Consent requirements (no consent checkbox)
- GDPR module checks Art. 17: Right to erasure (no deletion mechanism)
- GDPR module checks Art. 25: Pre-checked consent boxes (not privacy by default)
- GDPR module checks Art. 32: Security headers (missing HSTS/CSP)
- GDPR module checks Art. 35: DPIA for high-risk data (sensitive data without privacy policy)
- Both modules only report findings when data collection/payment detected
- All findings include cwe_id via CWEMapper mapping
- Plan committed with atomic task commits
</success_criteria>

<output>
After completion, create `.planning/phases/10-cybersecurity-deep-dive/10-03-SUMMARY.md`
</output>
