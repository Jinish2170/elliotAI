---
phase: 10-cybersecurity-deep-dive
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - veritas/analysis/security/base.py
  - veritas/analysis/security/__init__.py
  - veritas/analysis/security/utils.py
  - veritas/analysis/security/tls_ssl.py
  - veritas/analysis/security/cookies.py
  - veritas/analysis/security/csp.py
  - veritas/config/security_rules.py
autonomous: true
requirements:
  - SEC-01
user_setup: []

must_haves:
  truths:
    - SecurityModule base class provides tier classification and async analyze() interface
    - SecurityFinding dataclass contains category_id, pattern_type, severity, confidence, evidence, cwe_id, cvss_score
    - FAST tier modules (TLS/SSL, cookies, CSP) execute in parallel under 5 seconds
    - CWEMapper from Phase 9 is integrated for CWE ID mapping
    - CVSSCalculator from Phase 9 is integrated for severity scoring
  artifacts:
    - path: veritas/analysis/security/base.py
      provides: SecurityModule base class, SecurityFinding dataclass, SecurityTier enum
      min_lines: 80
    - path: veritas/analysis/security/utils.py
      provides: Module auto-discovery, tier grouping, get_all_security_modules()
      exports: ["get_all_security_modules", "group_modules_by_tier"]
    - path: veritas/analysis/security/tls_ssl.py
      provides: TLS SSL certificate analysis, security header checking
      exports: ["SSLCertificateAnalyzer", "SecurityHeaderAnalyzer"]
    - path: veritas/analysis/security/cookies.py
      provides: Cookie security analysis (Secure, HttpOnly, SameSite)
      exports: ["CookieSecurityAnalyzer"]
    - path: veritas/analysis/security/csp.py
      provides: Content Security Policy validation
      exports: ["ContentSecurityPolicyAnalyzer"]
    - path: veritas/config/security_rules.py
      provides: CWE mappings, severity rules, rule configuration
      exports: ["cwemapper", "cvss_calculator"]
  key_links:
    - from: veritas/analysis/security/base.py
      to: veritas/cwe/cvss_calculator.py
      via: import veritas.cwe.cvss_calculator
      pattern: "from veritas.cwe.cvss_calculator import CVSSCalculator"
    - from: veritas/analysis/security/base.py
      to: veritas/cwe/registry.py
      via: import veritas.cwe.registry
      pattern: "from veritas.cwe.registry import CWERegistry"
    - from: veritas/analysis/security/utils.py
      to: veritas/analysis/security/base.py
      via: import SecurityModule
      pattern: "from .base import SecurityModule"
---

<objective>
Create security module foundation architecture with base classes, tier execution framework, and FAST tier implementations (TLS/SSL, cookies, CSP) that integrate with Phase 9's CVSS/CWE components.

Purpose: Establish extensible security module architecture with tier-based execution, enabling efficient parallel analysis of 25+ security modules while maintaining integration with existing CVSS scoring and CWE mapping.

Output: SecurityModule base class, SecurityFinding dataclass, utility functions for module discovery and tier grouping, 3 FAST tier security modules, security rules configuration mapping findings to CWE/CVSS.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-judge-orchestrator/09-01-SUMMARY.md
@.planning/phases/10-cybersecurity-deep-dive/10-RESEARCH.md
@veritas/cwe/cvss_calculator.py
@veritas/cwe/registry.py
@veritas/agents/security_agent.py

# Key interfaces from Phase 9 CVSS/CWE integration

From veritas/cwe/cvss_calculator.py:
```python
@dataclass(frozen=True)
class CVSSMetrics:
    attack_vector: CWMetricStatus
    attack_complexity: CWMetricStatus
    privileges_required: CWMetricStatus
    user_interaction: CWMetricStatus
    scope: CWMetricStatus
    confidentiality: CWMetricStatus
    integrity: CWMetricStatus
    availability: CWMetricStatus

class CVSSCalculator:
    def calculate_base_score(self, metrics: CVSSMetrics) -> float
    def calculate_base_score_from_finding(self, finding: SecurityFinding) -> float
```

From veritas/cwe/registry.py:
```python
class CWERegistry:
    cwe_entries: List[CWEEntry]
    def find_cwe_by_category(self, category: str) -> List[CWEEntry]
    def map_finding_to_cwe(self, category: str, pattern_type: str) -> Optional[str]
```

# Existing security agent structure

From veritas/agents/security_agent.py:
- Uses function-based security modules (SecurityHeaderAnalyzer, PhishingChecker, etc.)
- Module auto-discovery via _MODULE_PRIORITY and _MODULE_WEIGHTS
- Existing SecurityConfig, SecurityFinding, SecurityResult types in core/types.py
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SecurityModule base class and SecurityFinding dataclass</name>
  <files>veritas/analysis/security/base.py, veritas/analysis/security/__init__.py</files>
  <action>
    Create base.py with:

    1. SecurityTier enum (FAST, MEDIUM, DEEP) with timeout suggestions (FAST < 5s, MEDIUM < 15s, DEEP < 30s)

    2. SecurityFinding dataclass with fields:
       - category_id: str (e.g., "owasp_a01", "security_headers")
       - pattern_type: str (specific vulnerability type)
       - severity: str ("low", "medium", "high", "critical")
       - confidence: float (0.0-1.0)
       - description: str (technical description)
       - evidence: str (what was found)
       - cwe_id: Optional[str] (CWE identifier)
       - cvss_score: Optional[float] (0.0-10.0)
       - recommendation: str (remediation guidance)
       - url_finding: bool = False

    3. SecurityModule abstract base class with:
       - timeout: int property (default 10, override per module)
       - tier: SecurityTier property (default MEDIUM, override per module)
       - category_id: abstract property (returns module identifier)
       - async analyze() abstract method with signature:
         async def analyze(self, url: str, page_content: Optional[str] = None,
                          headers: Optional[dict] = None, dom_meta: Optional[dict] = None) -> List[SecurityFinding]
       - to_dict() method for progress streaming

    4. Create __init__.py with base exports:
       - from .base import SecurityModule, SecurityFinding, SecurityTier

  IMPORTANT: Do NOT create duplicate SecurityFinding dataclass - check if one exists in core/types.py and reuse it. Extend if needed to add cwe_id and cvss_score fields.
  </action>
  <verify>
    <automated>python -c "from veritas.analysis.security import SecurityModule, SecurityFinding, SecurityTier; SecurityTier.FAST; print('Base class imports work')"</automated>
  </verify>
  <done>SecurityModule base class with SecurityTier enum and SecurityFinding dataclass (extended from core/types.py if exists) created in veritas/analysis/security/base.py</done>
</task>

<task type="auto">
  <name>Task 2: Create security utilities for module discovery and tier grouping</name>
  <files>veritas/analysis/security/utils.py, veritas/config/security_rules.py</files>
  <action>
    Create utils.py with:

    1. get_all_security_modules() function:
       - Uses importlib to discover all SecurityModule subclasses in veritas.analysis.security
       - Returns list of module classes

    2. group_modules_by_tier() function:
       - Input: list of SecurityModule classes
       - Output: Dict[SecurityTier, List[type[SecurityModule]]]
       - Groups by tier property

    3. execute_tier() async helper:
       - Executes modules in the same tier in parallel using asyncio.gather
       - Returns flatten list of all findings
       - Applies timeout per module (asyncio.timeout(module.timeout))
       - Handles exceptions gracefully (log and continue)

    Create config/security_rules.py with:

    1. Import CWEMapper and CVSSCalculator from Phase 9:
       - from veritas.cwe.registry import CWERegistry
       - from veritas.cwe.cvss_calculator import CVSSCalculator

    2. cwemapper instance: CWERegistry() singleton

    3. cvss_calculator instance: CVSSCalculator() singleton

    4. CWE severity mapping table:
       - Maps category_id and pattern_type to default severity (low/medium/high/critical)
       - Example: {"owasp_a01": {"admin_panel_no_auth": "critical", "idor": "high"}}

    5. Default CVSS metrics per severity:
       - critical: {"attack_vector": "N", "attack_complexity": "L", "privileges_required": "N"}
       - high: {"attack_vector": "N", "attack_complexity": "L", "privileges_required": "L"}
       - medium: {"attack_vector": "A", "attack_complexity": "L", "privileges_required": "L"}
       - low: {"attack_vector": "L", "attack_complexity": "H", "privileges_required": "H"}
  </action>
  <verify>
    <automated>python -c "from veritas.analysis.security.utils import get_all_security_modules, group_modules_by_tier; from veritas.config.security_rules import cwemapper, cvss_calculator; print('Utility imports work'); modules = get_all_security_modules(); print(f'Found {len(modules)} security modules')"</automated>
  </verify>
  <done>Utility functions for module discovery and tier grouping created, security_rules.py configured with CWEMapper/CVSSCalculator from Phase 9</done>
</task>

<task type="auto">
  <name>Task 3: Implement FAST tier security modules (TLS/SSL, Cookies, CSP)</name>
  <files>veritas/analysis/security/tls_ssl.py, veritas/analysis/security/cookies.py, veritas/analysis/security/csp.py</files>
  <action>
    Create 3 FAST tier security modules:

    1. tls_ssl.py with SecurityHeaderAnalyzerEnhanced:
       - Tier: FAST, timeout: 5
       - Check required security headers:
         * Strict-Transport-Security (CWE-523, high)
         * Content-Security-Policy (CWE-693, high)
         * X-Frame-Options (CWE-1021, medium)
         * X-Content-Type-Options (CWE-693, medium)
       - Validate HSTS configuration if present (must have max-age=)
       - Returns SecurityFinding for each missing/misconfigured header with CWE ID mapping

    2. cookies.py with CookieSecurityAnalyzer:
       - Tier: FAST, timeout: 5
       - Analyze Set-Cookie headers:
         * Missing Secure flag for HTTPS cookies (CWE-614, high)
         * Missing HttpOnly flag (CWE-1004, medium)
         * Missing SameSite attribute (CWE-942, low)
         * SameSite=None without Secure (medium)
       - Returns SecurityFinding for each cookie security issue with CWE ID mapping

    3. csp.py with ContentSecurityPolicyAnalyzer:
       - Tier: FAST, timeout: 5
       - Parse CSP header:
         * Check for valid CSP policy exists
         * Check for unsafe-inline in script-src (CWE-829, high)
         * Check for unsafe-eval in script-src (CWE-95, high)
         * Check for overly permissive directives (default-src: *) (medium)
       - Returns SecurityFinding for each CSP violation with CWE ID mapping

    All modules:
   - Extend SecurityModule base class
   - Set category_id property (e.g., "security_headers", "cookies", "csp")
   - Analyze headers dict from HTTP response
   - Use config.security_rules.cwemapper for CWE ID mapping
   - Return List[SecurityFinding] (empty if no issues)
  </action>
  <verify>
    <automated>python -c "from veritas.analysis.security.tls_ssl import SecurityHeaderAnalyzerEnhanced; from veritas.analysis.security.cookies import CookieSecurityAnalyzer; from veritas.analysis.security.csp import ContentSecurityPolicyAnalyzer; a = SecurityHeaderAnalyzerEnhanced(); c = CookieSecurityAnalyzer(); p = ContentSecurityPolicyAnalyzer(); print(f'{a.category_id}, {c.category_id}, {p.category_id}')"</automated>
  </verify>
  <done>3 FAST tier security modules (TLS/SSL, cookies, CSP) implemented with SecurityModule base class and CWE ID mapping</done>
</task>

</tasks>

<verification>
All 3 FAST tier security modules auto-discoverable via get_all_security_modules(), each module returns findings with valid CWE IDs and severity mappings, tier grouping groups all 3 modules under FAST tier
</verification>

<success_criteria>
- SecurityModule base class provides tier classification and async analyze interface
- SecurityFinding dataclass includes cwe_id and cvss_score fields
- get_all_security_modules() discovers all 3 FAST tier modules
- group_modules_by_tier() returns {SecurityTier.FAST: [3 modules]}
- TLS/SSL module checks 4 required security headers with CWE mapping
- Cookie module checks Secure/HttpOnly/SameSite for security issues
- CSP module validates policy for unsafe-inline, unsafe-eval, default-src:*
- CWEMapper and CVSSCalculator from Phase 9 imported in config/security_rules.py
- All tests pass with module imports and basic functionality
- Plan committed to git with atomic task commits
</success_criteria>

<output>
After completion, create `.planning/phases/10-cybersecurity-deep-dive/10-01-SUMMARY.md`
</output>
