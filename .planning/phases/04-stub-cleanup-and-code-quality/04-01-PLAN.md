---
phase: 04-stub-cleanup-and-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - veritas/core/evidence_store.py
autonomous: true
requirements:
  - CORE-04
  - CORE-04-2
  - CORE-06-4

must_haves:
  truths:
    - "search_similar() raises ValueError when LanceDB table does not exist"
    - "get_all_audits() raises ValueError when LanceDB audits table does not exist"
    - "_json_search() raises FileNotFoundError when JSONL file does not exist"
    - "_json_list_all() raises FileNotFoundError when JSONL file does not exist"
    - "_json_search() raises RuntimeError when JSON parsing fails"
    - "_json_list_all() raises RuntimeError when JSON parsing fails"
  artifacts:
    - path: "veritas/core/evidence_store.py"
      provides: "EvidenceStore with proper error handling"
      min_lines: 170
      contains:
        - "search_similar"
        - "get_all_audits"
        - "_json_search"
        - "_json_list_all"
        - "raise ValueError"
        - "raise FileNotFoundError"
        - "raise RuntimeError"
  key_links:
    - from: "veritas/core/evidence_store.py:search_similar"
      to: "LanceDB.table_names()"
      via: "table existence check"
      pattern: "table_name not in self._db.table_names()"
    - from: "veritas/core/evidence_store.py:get_all_audits"
      to: "LanceDB.table_names()"
      via: "table existence check"
      pattern: '"audits" not in self._db.table_names()'
---

<objective>
Replace empty return stubs in evidence_store.py with context-specific exceptions to eliminate silent failures and improve observability.

Purpose: Empty returns mask bugs by silently returning empty results when tables don't exist or file operations fail. Raising exceptions makes these failures explicit and discoverable.

Output: evidence_store.py with proper error handling at lines 207, 250, 309, 327, 351, 362.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-stub-cleanup-and-code-quality/04-CONTEXT.md
@.planning/phases/04-stub-cleanup-and-code-quality/04-RESEARCH.md
@veritas/core/evidence_store.py
@veritas/tests/test_veritas.py
</context>

<tasks>

<task type="auto">
  <name>Task 0: Search for existing callers of stub methods</name>
  <files>veritas/core/evidence_store.py</files>
  <action>
Before modifying stub methods, search for existing callers in the codebase using grep patterns. This is required per migration decision in 04-CONTEXT.md.

Search for all calls to the following methods:
- search_similar()
- get_all_audits()
- _json_search()
- _json_list_all()

Use grep patterns:
```bash
grep -rn "search_similar(" veritas/ --include="*.py"
grep -rn "get_all_audits(" veritas/ --include="*.py"
grep -rn "_json_search(" veritas/ --include="*.py"
grep -rn "_json_list_all(" veritas/ --include="*.py"
```

Analyze results:
1. If callers found, document:
   - Which methods are called
   - Where they are called (file:line)
   - How callers handle return values
2. If no callers found, report this as confirmation that stub replacement is safe
3. If callers exist and expect empty returns, evaluate whether to:
   - Update callers first (preferred migration path)
   - Implement the full method now (if feasible)

Return analysis summary before proceeding with Task 1 stub replacement.
  </action>
  <verify>grep -rn "search_similar(" veritas/ --include="*.py" && grep -rn "get_all_audits(" veritas/ --include="*.py" && grep -rn "_json_search(" veritas/ --include="*.py" && grep -rn "_json_list_all(" veritas/ --include="*.py"</verify>
  <done>Caller analysis complete with documented findings on method usage patterns</done>
</task>

<task type="auto">
  <name>Task 1: Replace evidence_store.py stubs with proper exceptions</name>
  <files>veritas/core/evidence_store.py</files>
  <action>
Modify veritas/core/evidence_store.py to replace empty return stubs with context-specific exceptions:

1. Line ~207 (search_similar method):
   - Replace `return []` when `table_name not in self._db.table_names()`
   - Raise ValueError: "search_similar(): Table '{table_name}' does not exist. Available tables: {self._db.table_names()}"

2. Line ~250 (get_all_audits method):
   - Replace `return []` when `"audits" not in self._db.table_names()`
   - Raise ValueError: "get_all_audits(): 'audits' table does not exist. Available tables: {self._db.table_names()}"

3. Line ~309 (_json_search method):
   - Replace `return []` when `not filepath.exists()`
   - Raise FileNotFoundError: f"_json_search(): JSONL file not found: {filepath}"

4. Line ~327 (_json_search method):
   - Replace `return []` in except Exception block
   - Raise RuntimeError: f"_json_search(): Failed to read JSONL file {filepath}: {e}"

5. Line ~351 (_json_list_all method):
   - Replace `return []` when `not filepath.exists()`
   - Raise FileNotFoundError: f"_json_list_all(): JSONL file not found: {filepath}"

6. Line ~362 (_json_list_all method):
   - Replace `return []` in except Exception block
   - Raise RuntimeError: f"_json_list_all(): Failed to read JSONL file {filepath}: {e}"

Use context-specific error type per user decision in 04-CONTEXT.md:
- ValueError for missing tables (invalid/missing resources)
- FileNotFoundError for missing files
- RuntimeError for file operation failures

Include method name in error message for debugging context per research guidance.
  </action>
  <verify>python -m pytest veritas/tests/test_veritas.py::TestEvidence -v</verify>
  <done>All six stub locations in evidence_store.py raise appropriate exceptions instead of returning empty lists</done>
</task>

</tasks>

<verification>
1. Verify search_similar raises ValueError for missing LanceDB tables
2. Verify get_all_audits raises ValueError for missing audits table
3. Verify _json_search raises FileNotFoundError for missing JSONL files
4. Verify _json_list_all raises FileNotFoundError for missing JSONL files
5. Verify _json_search raises RuntimeError for JSON parse failures
6. Verify _json_list_all raises RuntimeError for JSON parse failures
7. No empty return statements at lines 207, 250, 309, 327, 351, 362
</verification>

<success_criteria>
1. All evidence_store.py stubs (lines 207, 250, 309, 327, 351, 362) raise context-specific exceptions
2. Error messages include method name and context for debugging
3. No silent failures from empty returns in evidence_store.py
4. Code follows patterns from 04-RESEARCH.md (ValueError for missing resources, FileNotFoundError for missing files, RuntimeError for state issues)
</success_criteria>

<output>
After completion, create `.planning/phases/04-stub-cleanup-and-code-quality/04-01-SUMMARY.md`
</output>
