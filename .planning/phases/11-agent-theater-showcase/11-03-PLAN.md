---
phase: 11-agent-theater-showcase
plan: 03
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - frontend/src/components/audit/RunningLog.tsx
  - frontend/src/components/audit/GreenFlagCelebration.tsx
  - frontend/src/components/audit/NarrativeFeed.tsx
  - frontend/src/lib/types.ts
  - frontend/package.json
autonomous: true
requirements:
  - SHOWCASE-01
  - SHOWCASE-04
user_setup: []

must_haves:
  truths:
    - Running log displays agent activity messages with timestamps and personality context
    - Log window limits to 100 entries with sliding window (oldest evicted when full)
    - Task completion celebrations display ("Vision found 3 dark patterns!") with confetti
    - Green flag celebration banner appears prominently when trust_score >= 80
    - Green flags are listed (valid SSL, HTTPS enforced, contact info visible, etc.)
    - Confetti animation triggers on audit completion and high-trust results
  artifacts:
    - path: frontend/src/components/audit/RunningLog.tsx
      provides: Extended log component with windowing and personality messages
      exports: ["RunningLog"]
      min_lines: 180
    - path: frontend/src/components/audit/GreenFlagCelebration.tsx
      provides: Celebration component for positive audits
      exports: ["GreenFlagCelebration"]
      min_lines: 150
    - path: frontend/src/lib/types.ts
      provides: GreenFlag type, extended LogEntry with personality
      exports: ["GreenFlag", "LogEntry", "AuditResult"]
      min_lines: 200
  key_links:
    - from: frontend/src/components/audit/RunningLog.tsx
      to: frontend/src/lib/store.ts
      via: useAuditStore to access logs
      pattern: "useAuditStore"
    - from: frontend/src/components/audit/GreenFlagCelebration.tsx
      to: frontend/src/lib/types.ts
      via: import GreenFlag type
      pattern: "GreenFlag"
    - from: frontend/src/components/audit/NarrativeFeed.tsx
      to: frontend/src/components/audit/GreenFlagCelebration.tsx
      via: display celebration on audit complete
      pattern: "GreenFlagCelebration"
---

<objective>
Create running log component with automatic windowing and personality-based messages, and green flag celebration component that prominently displays positive audit results with confetti animations.

Purpose: Provide engaging real-time feedback through a curated log stream showing agent activities with character context, and celebrate positive audit outcomes with prominent banners and visual effects, reinforcing the "masterpiece" quality of the system.

Output: RunningLog component with 100-entry sliding window, GreenFlagCelebration component with banner animation and green flags list, canvas-confetti integration for celebrations, updated NarrativeFeed triggering celebrations, extended types for green flags.
</object>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-agent-theater-showcase/11-RESEARCH.md
@.planning/phases/11-agent-theater-showcase/11-01-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/components/audit/ForensicLog.tsx
@frontend/src/components/audit/NarrativeFeed.tsx
@frontend/src/lib/store.ts

# Key interfaces from existing codebase

From frontend/src/lib/types.ts (after Plan 11-01):
```typescript
export interface LogEntry {
  timestamp: string;
  agent: string;
  message: string;
  level: "info" | "warn" | "error";
}

export interface AuditResult {
  url: string;
  status: string;
  trust_score: number;
  risk_level: string;
  recommendations: string[];
  // ... other fields
}
```

From frontend/src/lib/store.ts:
- logs: LogEntry[] stores all log entries
- handleEvent adds "log_entry" events to logs array

From frontend/src/components/audit/ForensicLog.tsx:
- Basic log display component
- Simple table/render of log entries
- No windowing or personality integration

From frontend/src/components/audit/NarrativeFeed.tsx:
- CompletionCard shows audit complete with trust score
- Uses framer-motion animations

# Research findings from 11-RESEARCH.md

Celebration recommendations:
- Use canvas-confetti for animations (lightweight ~40KB)
- Trigger on audit complete and trust_score >= 80
- Green flags list: valid SSL, HTTPS enforced, contact info visible, etc.

Running log patterns:
- Windowing: max 100 entries, sliding window (evict oldest when full)
- Personality messages: use getPersonalityMessage from Plan 11-01
- Timestamp formatting: relative time (e.g., "2m ago") or absolute
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install canvas-confetti and extend types for green flags</name>
  <files>frontend/package.json, frontend/src/lib/types.ts</files>
  <action>
    Run: cd frontend && npm install canvas-confetti --save

    Modify frontend/src/lib/types.ts:

    1. Create GreenFlag interface:
       ```typescript
       export interface GreenFlag {
         id: string;
         category: string; // "security", "privacy", "compliance", "trust"
         label: string; // human-readable description
         icon: string; // emoji icon
       }
       ```

    2. Add green_flags to AuditResult interface:
       ```typescript
       export interface AuditResult {
         // ... existing fields
         green_flags?: GreenFlag[]; // list of positive indicators
       }
       ```

    3. Extend LogEntry interface:
       ```typescript
       export interface LogEntry {
         timestamp: string;
         agent: string;
         message: string;
         level: "info" | "warn" | "error";
         context?: "working" | "complete" | "success" | "error"; // for personality context
         params?: Record<string, unknown>; // for message substitution
       }
       ```

    4. Create green flag definitions:
       ```typescript
       export const COMMON_GREEN_FLAGS: GreenFlag[] = [
         { id: "ssl-valid", category: "security", label: "Valid SSL Certificate", icon: "üîí" },
         { id: "https enforced", category: "security", label: "HTTPS Enforced", icon: "üõ°Ô∏è" },
         { id: "contact-visible", category: "trust", label: "Contact Information Visible", icon: "üìû" },
         { id: "privacy-policy", category: "privacy", label: "Privacy Policy Found", icon: "üìÑ" },
         { id: "terms-of-service", category: "compliance", label: "Terms of Service Found", icon: "‚öñÔ∏è" },
         { id: "no-dark-patterns", category: "trust", label: "No Dark Patterns Detected", icon: "‚ú®" },
         { id: "valid-domain-age", category: "trust", label: "Valid Domain Age", icon: "üìÖ" },
       ];
       ```

    5. Create utility function for relative time formatting:
       ```typescript
       export function formatRelativeTime(timestamp: string): string {
         const now = Date.now();
         const then = new Date(timestamp).getTime();
         const diff = now - then;

         const seconds = Math.floor(diff / 1000);
         const minutes = Math.floor(seconds / 60);
         const hours = Math.floor(minutes / 60);

         if (seconds < 60) return `${seconds}s ago`;
         if (minutes < 60) return `${minutes}m ago`;
         if (hours < 24) return `${hours}h ago`;
         return new Date(timestamp).toLocaleDateString();
       }
       ```
  </action>
  <verify>
    <automated>cd frontend && grep canvas-confetti package.json && npx tsx -e "import { COMMON_GREEN_FLAGS, formatRelativeTime } from './src/lib/types'; console.log(COMMON_GREEN_FLAGS); console.log(formatRelativeTime(new Date(Date.now() - 125000).toISOString()))"</automated>
  </verify>
  <done>canvas-confetti installed, GreenFlag interface created, AuditResult extended with green_flags field, LogEntry extended with context/params fields, COMMON_GREEN_FLAGS constant defined, formatRelativeTime utility function created</done>
</task>

<task type="auto">
  <name>Task 2: Create RunningLog component with windowing and personality messages</name>
  <files>frontend/src/components/audit/RunningLog.tsx</files>
  <action>
    Create frontend/src/components/audit/RunningLog.tsx with:

    1. Component props:
       ```typescript
       interface RunningLogProps {
         maxEntries?: number; // default 100
         showPersonality?: boolean; // default true
       }
       ```

    2. State and hooks:
       - useAuditStore to get logs
       - useMemo to apply windowing (last maxEntries)
       - useAutoScroll to scroll to bottom on new logs

    3. Windowing logic:
       ```typescript
       const windowedLogs = useMemo(() => {
         if (logs.length <= maxEntries) return logs;
         return logs.slice(-(maxEntries));
       }, [logs, maxEntries]);
       ```

    4. Render structure:
       - Log container with fixed height and overflow-y-auto
       - Each log entry:
         * Timestamp badge (formatRelativeTime)
         * Agent emoji (from PHASE_META or AGENT_PERSONALITIES)
         * Message (with personality context if available)
         * Color coding (gray=info, yellow=warn, red=error)
         * "Flex" emphasis for success/complete messages with context="complete"

    5. Personality integration (Plan 11-01):
       - Import getPersonalityMessage
       - If log entry has context and agent, use personality message
       - For "complete" context, emphasize with larger text and celebration icon

    6. Formatting patterns:
       - Working context: "üïµÔ∏è Scout: Scouting the perimeter..."
       - Complete context: "üëÅÔ∏è Vision: Visual scan complete! 3 findings detected!"
       - Success context: "üõ°Ô∏è Security: Security audit complete! All checks passed!"
       - Error context: "‚ùå Vision: Visual obscured..."

    7. Auto-scroll:
       - Scroll to bottom when new logs arrive
       - Use useEffect with logs dependency
       - Only auto-scroll if user hasn't manually scrolled up (check scroll position)

    Use framer-motion for entry animations (sliding in from bottom).
  </action>
  <verify>
    <automated>cd frontend && npm run build 2>&1 | grep -E "(RunningLog|error|Error)" | head -10</automated>
  </verify>
  <done>RunningLog component created with 100-entry windowing, personality message integration, relative timestamps, color coding by level, auto-scroll behavior, flex message emphasis</done>
</task>

<task type="auto">
  <name>Task 3: Create GreenFlagCelebration component with confetti and integrate</name>
  <files>frontend/src/components/audit/GreenFlagCelebration.tsx, frontend/src/components/audit/NarrativeFeed.tsx</files>
  <action>
    Create frontend/src/components/audit/GreenFlagCelebration.tsx with:

    1. Component props:
       ```typescript
       interface GreenFlagCelebrationProps {
         trustScore: number;
         greenFlags: GreenFlag[];
         onDismiss?: () => void;
       }
       ```

    2. Conditional rendering:
       - Only display if trustScore >= 80
       - Return null otherwise

    3. Main banner structure:
       - Full-width banner with emerald-500 theme
       - "üéâ Congratulations!" header
       - Trust score display (large, emphasized)
       - "This site appears trustworthy!" message
       - Dismiss button

    4. Green flags grid:
       - 2x3 or 3x2 grid layout
       - Each flag:
         * Emoji icon
         * Label text
         * Category badge (security/privacy/trust/compliance)
       - Category color coding (emerald, cyan, purple, blue)

    5. Confetti animation:
       - On mount, trigger canvas-confetti
       - Config: spread: 70, particleCount: 150, colors: emerald, cyan, purple
       - Trigger again on "Celebrate" button (optional replay)

    6. Framer Motion animations:
       - Banner slides in from top (initial: y: -100, animate: y: 0)
       - Green flags stagger in (delay: index * 0.1)
       - Pulse effect on trust score

    Modify frontend/src/components/audit/NarrativeFeed.tsx:
    1. Add confetti trigger to CompletionCard:
       - If trust_score >= 80, trigger confetti
       - Import confetti from canvas-confetti
       - Add useEffect to run confetti on mount

    2. Add GreenFlagCelebration integration:
       - If result.green_flags exists and trust_score >= 80, show celebration banner
       - Place below CompletionCard or as overlay

    3. Add "flex" message completion integration:
       - On phase_complete, get personality message with context="complete"
       - Update agent state message with personality flex
       - Display in NarrativeFeed with celebration style

    4. Enhance CompletionCard:
       - If trust_score >= 80, show green-themed styling
       - Add "Check passed!" badges
       - Include green flag count
  </action>
  <verify>
    <automated>cd frontend && npm run build 2>&1 | grep -E "(GreenFlagCelebration|NarrativeFeed|error|Error)" | head -15</automated>
  </verify>
  <done>GreenFlagCelebration component created with banner animation, green flags grid, confetti effect, confetti imported and integrated, NarrativeFeed updated to trigger celebrations and show banner, CompletionCard enhanced with green theme for high scores</done>
</task>

</tasks>

<verification>
RunningLog shows last 100 entries, older entries evicted when window full, personality messages displayed with agent emojis, timestamps formatted as relative time, auto-scroll works, GreenFlagCelebration banner appears when trust_score >= 80, green flags display in grid with icons and categories, confetti animation triggers on high-trust completion, celebrations appear in NarrativeFeed on task completion
</verification>

<success_criteria>
- canvas-confetti installed in package.json dependencies
- GreenFlag interface exported with id, category, label, icon fields
- AuditResult extended with green_flags?: GreenFlag[]
- LogEntry extended with context and params fields
- COMMON_GREEN_FLAGS constant with 7 common green flags
- formatRelativeTime returns "Xm ago" or "Xh ago" or date
- RunningLog handles logs prop with windowed display (max 100 entries)
- RunningLog shows agent emojis from AGENT_PERSONALITIES/PHASE_META
- RunningLog formats messages with personality context (complete/success flex style)
- RunningLog color codes by level (info/warn/error)
- RunningLog auto-scrolls to bottom on new logs
- GreenFlagCelebration only renders when trust_score >= 80
- GreenFlagCelebration displays banner with emerald theme, trust score, message
- GreenFlagCelebration shows green flags in grid layout (emoji, label, category)
- GreenFlagCelebration triggers canvas-confetti animation on mount
- NarrativeFeed CompletionCard calls confetti when trust_score >= 80
- NarrativeFeed shows GreenFlagCelebration banner after CompletionCard
- NarrativeFeed displays personality flex messages on phase_complete
- TypeScript compiles without errors
- Plan committed with atomic task commits
</success_criteria>

<output>
After completion, create `.planning/phases/11-agent-theater-showcase/11-03-SUMMARY.md`
</output>
