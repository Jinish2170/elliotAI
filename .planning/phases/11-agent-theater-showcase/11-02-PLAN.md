---
phase: 11-agent-theater-showcase
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/components/audit/ScreenshotCarousel.tsx
  - frontend/src/components/audit/EvidencePanel.tsx
  - frontend/src/lib/store.ts
autonomous: true
requirements:
  - SHOWCASE-02
  - SHOWCASE-03
user_setup: []

must_haves:
  truths:
    - User can navigate through screenshot carousel with prev/next buttons and keyboard shortcuts
    - Findings are highlighted on screenshots with SVG overlay rectangles
    - Overlay coordinates correctly align with findings (bbox percentages converted to pixels)
    - Screenshots can be zoomed in/out with pan capability
    - Toggle to show/hide finding overlays on screenshots
    - Thumbnail navigation strip shows all screenshots with finding indicators
  artifacts:
    - path: frontend/src/components/audit/ScreenshotCarousel.tsx
      provides: Full-featured carousel with overlays, zoom, navigation
      exports: ["ScreenshotCarousel"]
      min_lines: 300
    - path: frontend/src/lib/types.ts
      provides: Extended Screenshot type with findings array, HighlightOverlay type
      exports: ["Screenshot", "HighlightOverlay", "Finding"]
      min_lines: 180
    - path: frontend/src/lib/store.ts
      provides: Updated state management for finding screenshots association
      exports: ["useAuditStore"]
      min_lines: 330
    - path: frontend/src/components/audit/EvidencePanel.tsx
      provides: Updated to use new ScreenshotCarousel component
      exports: ["EvidencePanel"]
      min_lines: 250
  key_links:
    - from: frontend/src/components/audit/ScreenshotCarousel.tsx
      to: frontend/src/lib/types.ts
      via: import Finding, Screenshot, HighlightOverlay types
      pattern: "from '@/lib/types' import .*"
    - from: frontend/src/components/audit/ScreenshotCarousel.tsx
      to: frontend/src/components/audit/EvidencePanel.tsx
      via: EvidencePanel consumes ScreenshotCarousel component
      pattern: "import.*ScreenshotCarousel"
    - from: frontend/src/lib/store.ts
      to: frontend/src/components/audit/ScreenshotCarousel.tsx
      via: props passed from store state
      pattern: "screenshots.*findings"
---

<objective>
Create full-featured screenshot carousel component with finding highlight overlays, zoom/pan capabilities, and navigation controls for visual exploration of audit evidence.

Purpose: Enable users to visually explore screenshots with finding highlights, zoom for detailed inspection, and navigate through the screenshot series with intuitive controls, providing an engaging visual showcase of detected patterns and evidence.

Output: ScreenshotCarousel component with SVG overlay system for finding highlights, zoom/pan interactions, thumbnail navigation strip, keyboard controls, and toggle for overlay visibility. EvidencePanel updated to use the new carousel.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-agent-theater-showcase/11-RESEARCH.md
@.planning/phases/11-agent-theater-showcase/11-01-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/components/audit/EvidencePanel.tsx

# Key interfaces from existing codebase

From frontend/src/lib/types.ts (after Plan 11-01):
```typescript
export interface Finding {
  id: string;
  category: string;
  pattern_type: string;
  severity: "low" | "medium" | "high" | "critical";
  confidence: number;
  description: string;
  plain_english: string;
  screenshot_index?: number;
  bbox?: [number, number, number, number]; // x, y, width, height percentages (Plan 11-01)
}

export interface Screenshot {
  url: string;
  label: string;
  index: number;
  data?: string; // base64
}
```

From frontend/src/components/audit/EvidencePanel.tsx:
- Existing ScreenshotGallery component with lightbox modal
- Basic grid layout with click-to-expand
- Currently shows screenshots as grid or modal
- Needs to be replaced with ScreenshotCarousel

# Component patterns from research (11-RESEARCH.md)

Coordinate conversion formula (bbox 0-100 scale â†’ pixels):
```typescript
const toPixels = (bbox: number[], width: number, height: number) => ({
  x: (bbox[0] / 100) * width,
  y: (bbox[1] / 100) * height,
  width: (bbox[2] / 100) * width,
  height: (bbox[3] / 100) * height
});
```

Overlay color mapping:
- critical: red-500
- high: orange-500
- medium: amber-500
- low: green-500
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types for screenshots with findings association</name>
  <files>frontend/src/lib/types.ts</files>
  <action>
    Modify frontend/src/lib/types.ts:

    1. Create HighlightOverlay interface:
       ```typescript
       export interface HighlightOverlay {
         findingId: string;
         bbox: [number, number, number, number]; // x, y, width, height percentages
         severity: Finding["severity"];
         opacity: number; // 0.0-1.0, based on confidence
       }
       ```

    2. Extend Screenshot interface:
       ```typescript
       export interface Screenshot {
         url: string;
         label: string;
         index: number;
         data?: string; // base64
         width?: number; // actual pixel width
         height?: number; // actual pixel height
         findings?: Finding[]; // findings associated with this screenshot
         overlays?: HighlightOverlay[]; // pre-calculated highlight overlays
       }
       ```

    3. Create utility function for bbox-to-pixels conversion:
       ```typescript
       export function bboxToPixels(
         bbox: [number, number, number, number],
         imageWidth: number,
         imageHeight: number
       ): { x: number; y: number; width: number; height: number } {
         return {
           x: (bbox[0] / 100) * imageWidth,
           y: (bbox[1] / 100) * imageHeight,
           width: (bbox[2] / 100) * imageWidth,
           height: (bbox[3] / 100) * imageHeight,
         };
       }
       ```

    4. Create severity-to-color mapping:
       ```typescript
       export const SEVERITY_OVERLAY_COLOR: Record<Finding["severity"], string> = {
         critical: "rgba(239, 68, 68, 0.3)", // red-500 with opacity
         high: "rgba(249, 115, 22, 0.3)", // orange-500
         medium: "rgba(245, 158, 11, 0.3)", // amber-500
         low: "rgba(34, 197, 94, 0.3)", // green-500
       };
       ```
  </action>
  <verify>
    <automated>cd frontend && npx tsx -e "import { bboxToPixels, SEVERITY_OVERLAY_COLOR } from './src/lib/types'; console.log(bboxToPixels([10, 20, 30, 40], 1920, 1080)); console.log(SEVERITY_OVERLAY_COLOR)"</automated>
  </verify>
  <done>Screenshot type extended with findings/overlays, HighlightOverlay interface created, bboxToPixels utility function and SEVERITY_OVERLAY_COLOR mapping added</done>
</task>

<task type="auto">
  <name>Task 2: Create ScreenshotCarousel component with overlays and navigation</name>
  <files>frontend/src/components/audit/ScreenshotCarousel.tsx</files>
  <action>
    Create frontend/src/components/audit/ScreenshotCarousel.tsx with:

    1. Component props:
       ```typescript
       interface ScreenshotCarouselProps {
         screenshots: Screenshot[];
         initialIndex?: number;
         onFindings?: (screenshotIndex: number) => Finding[]; // callback to get findings
       }
       ```

    2. State management (useState):
       - currentIndex: number (current screenshot index)
       - showOverlays: boolean (toggle overlay visibility)
       - zoom: number (1.0 = 100% zoom)
       - pan: {x: number, y: number} (pan offset in pixels)
       - isDragging: boolean (for pan interaction)

    3. Main carousel layout:
       - Full-size image container (relative positioning)
       - SVG overlay layer on top of image
       - Prev/Next navigation buttons
       - Thumbnail navigation strip (bottom)
       - Zoom controls (in/out buttons)
       - Toggle overlay button

    4. SVG overlay system:
       - Render findings[currentIndex].overlays or generate from bbox
       - Each finding rendered as <rect> element with:
         * x, y, width, height from bboxToPixels()
         * fill from SEVERITY_OVERLAY_COLOR[severity]
         * Stroke from solid color matching severity
         * Hover effect showing finding tooltip (pattern_type, confidence)
       - onClick on overlay opens finding details (optional - link to EvidencePanel)

    5. Zoom/Pan system:
       - Zoom in/out buttons modify zoom state (0.5x - 3.0x range)
       - Mouse drag updates pan state when zoomed
       - Apply transform: `scale(${zoom}) translate(${pan.x}px, ${pan.y}px)` to image container
       - Reset zoom/pan on screenshot change

    6. Thumbnail navigation strip:
       - Render all screenshots as small thumbnails (80x60px)
       - Highlight current thumbnail with cyan border
       - Show finding count indicator on each thumbnail (small badge)
       - Click thumbnail to jump to that screenshot

    7. Keyboard shortcuts (useEffect):
       - ArrowLeft/ArrowRight: navigate prev/next
       - +/-: zoom in/out
       - H: toggle overlays
       - Esc: exit zoom mode

    Use framer-motion for smooth transitions (AnimatePresence for carousel changes).
  </action>
  <verify>
    <automated>cd frontend && npm run build 2>&1 | grep -E "(ScreenshotCarousel|error|Error)" | head -10</automated>
  </verify>
  <done>ScreenshotCarousel component created with SVG overlay system, zoom/pan interactions, thumbnail navigation strip, keyboard controls, and overlay toggle</done>
</task>

<task type="auto">
  <name>Task 3: Update EvidencePanel to use ScreenshotCarousel and manage finding association</name>
  <files>frontend/src/components/audit/EvidencePanel.tsx, frontend/src/lib/store.ts</files>
  <action>
    Modify frontend/src/lib/store.ts:
    1. Update "screenshot" event handler in handleEvent():
       - Extract width, height from event if present
       - Associate findings by screenshot_index if provided
       - Generate overlays from finding.bbox if present
    2. Update "finding" event handler:
       - If finding has screenshot_index, append to that screenshot's findings array
       - Generate overlay for finding if bbox is present

    Modify frontend/src/components/audit/EvidencePanel.tsx:
    1. Replace existing ScreenshotGallery with ScreenshotCarousel:
       ```typescript
       import { ScreenshotCarousel } from '@/components/audit/ScreenshotCarousel';

       // In screenshots tab render:
       {activeTab === "screenshots" && (
         <motion.div key="screenshots" ...>
           {screenshots.length === 0 ? (
             <p className="text-xs text-[var(--v-text-tertiary)] text-center py-8">
               No screenshots yet
             </p>
           ) : (
             <ScreenshotCarousel screenshots={screenshots} />
           )}
         </motion.div>
       )}
       ```

    2. Remove old lightbox modal code (ScreenshotGallery component)
    3. Add carousel control hints below navigation:
       - "Arrow keys to navigate, +/- to zoom, H to toggle overlays"

    4. Ensure findings prop is passed or derived from store:
       - Either use store.findings directly
       - Or passScreenshot prop with associated findings

    Keep existing tabs structure (stats/screenshots/findings) but screenshots tab now uses ScreenshotCarousel.
  </action>
  <verify>
    <automated>cd frontend && npm run build 2>&1 | grep -E "(EvidencePanel|error|Error)" | head -10</automated>
  </verify>
  <done>EvidencePanel updated to use ScreenshotCarousel, store associates findings with screenshots by index, old ScreenshotGallery removed, control hints added</done>
</task>

</tasks>

<verification>
Screenshot carousel navigates all images with prev/next buttons and keyboard, finding overlays display correctly aligned with bbox coordinates, zoom works (0.5x-3.0x), pan follows mouse drag in zoomed mode, toggle overlays on/off works, thumbnail strip shows all screenshots with finding counts, EvidencePanel displays carousel in screenshots tab
</verification>

<success_criteria>
- HighlightOverlay interface exported with findingId, bbox, severity, opacity
- Screenshot type extended with width, height, findings, overlays fields
- bboxToPixels({bbox, width, height}) converts percentages to pixels correctly
- SEVERITY_OVERLAY_COLOR maps severity to rgba colors
- ScreenshotCarousel handles screenshots prop (array of Screenshot with findings)
- Current screenshot index state changes on prev/next and keyboard navigation
- SVG overlay layer renders HighlightOverlays with correct positioning
- Overlay rects show severity colors and hover tooltips
- Zoom in/out buttons modify zoom state (0.5-3.0 range)
- Pan state updated on mouse drag when zoomed
- Transform applied: style={{transform: `scale(${zoom}) translate(...)`}}
- Thumbnail strip renders all thumbnails with current selection highlight
- Finding count badges display on thumbnails with findings
- Keyboard shortcuts: ArrowLeft/Right navigate, +/- zoom, H toggles overlays
- EvidencePanel screenshots tab uses ScreenshotCarousel
- TypeScript compiles without errors
- Plan committed with atomic task commits
</success_criteria>

<output>
After completion, create `.planning/phases/11-agent-theater-showcase/11-02-SUMMARY.md`
</output>
