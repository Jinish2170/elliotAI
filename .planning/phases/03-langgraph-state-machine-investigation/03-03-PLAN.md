---
phase: 03-langgraph-state-machine-investigation
plan: 03
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - veritas/tests/langgraph_investigation/test_03_behavioral_differences.py
  - .planning/phases/03-langgraph-state-machine-investigation/03-RESOLUTION.md
autonomous: true
requirements:
  - CORE-03-4
  - CORE-03-5
  - CORE-03
  - CORE-06-3

must_haves:
  truths:
    - Behavioral differences between ainvoke() and sequential execution are observed and logged
    - Root cause of CancelledError is documented or error absence is noted
    - Resolution approach is determined (fix, version pin, hybrid, or sequential with tracking)
    - Sequential fallback is maintained for instant rollback capability
  artifacts:
    - path: veritas/tests/langgraph_investigation/test_03_behavioral_differences.py
      provides: Event flow comparison test between ainvoke() and sequential
      min_lines: 100
      contains: test_ainvoke_vs_sequential_behavior, test_event_order_verification
    - path: .planning/phases/03-langgraph-state-machine-investigation/03-RESOLUTION.md
      provides: Investigation findings and resolution documentation
      min_lines: 80
      contains: Root cause analysis, Recommended resolution, Fallback documentation
  key_links:
    - from: test_03_behavioral_differences.py
      to: test_01_minimal_graph.py
      via: Shared minimal graph patterns
      pattern: MinimalState|build_minimal_graph
    - from: test_03_behavioral_differences.py
      to: test_02_full_audit_mocked.py
      via: Mock patterns and AuditState reuse
      pattern: @patch.*NIM|AuditState
    - from: 03-RESOLUTION.md
      to: .planning/ROADMAP.md
      via: Phase 3 success criteria update
      pattern: Success Criteria.*LangGraph|Resolution documented

---

<objective>
Create behavioral difference observation test and document investigation findings with recommended resolution path based on test results.

Purpose: Compare execution flow between ainvoke() and sequential execution to identify where behavioral differences occur, document root cause findings, and determine resolution approach (enable proper ainvoke() or document enhanced sequential fallback with tracking).

Output: `veritas/tests/langgraph_investigation/test_03_behavioral_differences.py` with comparison tests, `03-RESOLUTION.md` documentation of findings and resolution.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-langgraph-state-machine-investigation/03-CONTEXT.md
@.planning/phases/03-langgraph-state-machine-investigation/03-RESEARCH.md
@.planning/STATE.md
@.planning/ROADMAP.md
@C:/files/coding dev era\elliot\elliotAI\.planning/research/LANGGRAPH.md

# Codebase references
@C:/files/coding dev era\elliot\elliotAI/veritas/core/orchestrator.py (sequential execution at line 1072)
@C:/files/coding dev era\elliot\elliotAI/veritas/core/ipc.py (ProgressEvent for logging)

# Prior plans
@.planning/phases/03-langgraph-state-machine-investigation/03-01-SUMMARY.md
@.planning/phases/03-langgraph-state-machine-investigation/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create behavioral differences comparison test</name>
  <files>veritas/tests/langgraph_investigation/test_03_behavioral_differences.py</files>
  <action>
    Create `veritas/tests/langgraph_investigation/test_03_behavioral_differences.py` with event flow comparison:

    1. Imports: `pytest`, `asyncio`, `time`, `typing.TypedDict, Any`, `langgraph.graph.StateGraph, END`, `sys`, `pathlib.Path`

    2. Add sys.path and import veritas modules

    3. Define `ObservableState(TypedDict)` with fields:
       - `step_log: list[str]`
       - `events: list[dict]`
       - `count: int`
       - `error_log: list[str]`

    4. Create `EventLogger` class with methods:
       - `__init__(name: str)` to initialize logger
       - `log(event_type: str, details: dict)` to record events with timestamp
       - `get_events()` to return logged events

    5. Create `observable_node(logger: EventLogger, node_name: str) -> Callable` factory that:
       - Returns async function wrapping node execution
       - Logs "node_start" before execution
       - Awaits asyncio.sleep(0.01) for async simulation
       - Logs "node_complete" after execution
       - Returns state update dict

    6. `test_ainvoke_vs_sequential_behavior()` test:
       - Use graph from test_01_minimal_graph (MinimalState with event tracking)
       - Run ainvoke() execution with event logger
       - Run manual sequential execution with separate event logger
       - Compare event orders and types
       - Print event sequences for visual comparison
       - Assert results are identical
       - Document any behavioral differences

    7. `test_event_order_verification()` test:
       - Build simple 3-node graph
       - Execute via ainvoke()
       - Verify nodes executed in correct order (sequential graph)
       - Verify no skipped or duplicated events
       - This validates LangGraph's event handling integrity

    8. `test_error_propagation_differences()` test:
       - Build graph with one node that raises Exception
       - Execute via ainvoke(): capture and verify error handling
       - Execute via sequential: capture and verify error handling
       - Compare error propagation behavior
       - Verify both handle errors consistently

    Use behavioral differences as primary evidence: event order, state transitions, timing, error propagation.
  </action>
  <verify>
    cd veritas && python -m pytest tests/langgraph_investigation/test_03_behavioral_differences.py -v -s
  </verify>
  <done>
    Behavioral differences test created with event logging, comparison logic, and output for observing any divergences.
  </done>
</task>

<task type="auto">
  <name>Document investigation findings and resolution</name>
  <files>.planning/phases/03-langgraph-state-machine-investigation/03-RESOLUTION.md</files>
  <action>
    Create `.planning/phases/03-langgraph-state-machine-investigation/03-RESOLUTION.md` documenting:

    1. **Investigation Summary**:
       - Python version tested (actual 3.11.5)
       - Tests executed: test_01_minimal_graph, test_02_full_audit_mocked, test_03_behavioral_differences
       - Each test result (pass/fail with key observations)

    2. **Root Cause Analysis**:
       - Did CancelledError occur? (YES/NO - with specifics)
       - Where did it originate? (LangGraph internals, NIMClient, subprocess, or not observed)
       - What behavioral differences were observed between ainvoke() and sequential?

    3. **Resolution Approach**:
       - Recommended path based on findings:
         a) **Fix enabled**: If no CancelledError, enable proper ainvoke() execution with enhancements
         b) **Version pin**: If Python 3.14 issue, pin to 3.12/3.13 with documentation
         c) **Hybrid execution**: Use ainvoke for simple cases, sequential for complex
         d) **Sequential with detailed tracking**: Maintain sequential but add comprehensive logging and mode tracking

    4. **Implementation Steps** (for resolution path):
       - Specific code changes needed in orchestrator.py
       - Any configuration changes (settings.py flags)
       - Testing requirements to verify resolution

    5. **Sequential Fallback Documentation**:
       - How instant rollback works
       - Feature flag or CLI toggle (if applicable)
       - When to fallback: error conditions, budget exhaustion, etc.

    6. **Open Questions & Further Investigation** (if any):
       - Unresolved issues
       - Items deferred to Phase 4 or v2 milestone

    Include test output snippets or links to test results where relevant.
  </action>
  <verify>
    cat .planning/phases/03-langgraph-state-machine-investigation/03-RESOLUTION.md
  </verify>
  <done>
    Resolution document created with root cause analysis, recommended resolution path, and fallback documentation.
  </done>
</task>

</tasks>

<verification>
1. Behavioral differences test captures event flow for both execution modes
2. Event logging shows order, timing, state transitions
3. Any CancelledError or exceptions with full traceback
4. Resolution.md documents findings clearly
5. Resolution path is actionable with specific implementation steps
6. Sequential fallback is documented for instant rollback
</verification>

<success_criteria>
1. Behavioral differences test executes and produces comparison output
2. Investigation findings clearly documented in 03-RESOLUTION.md
3. Root cause identified or error absence confirmed
4. Resolution approach determined and documented
5. Implementation steps are specific and actionable
6. Sequential fallback path is maintained and documented
</success_criteria>

<output>
After completion, create `.planning/phases/03-langgraph-state-machine-investigation/03-03-SUMMARY.md`
</output>
