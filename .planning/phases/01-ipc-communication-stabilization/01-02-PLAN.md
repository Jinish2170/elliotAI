---
phase: 01-ipc-communication-stabilization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - veritas/__main__.py
  - veritas/core/ipc.py
autonomous: true
requirements:
  - CORE-02-5
  - CORE-02-4

must_haves:
  truths:
    - CLI flags (--use-queue-ipc, --use-stdout, --validate-ipc) are parsed correctly
    - Environment variables (QUEUE_IPC_MODE, QUEUE_IPC_ROLLOUT) override default behavior
    - CLI flags take highest priority over environment variables
    - Queue mode defaults to 10% rollout when no flags specified
    - Mode determination follows CLI > ENV > Default priority
  artifacts:
    - path: veritas/__main__.py
      contains: --use-queue-ipc, --use-stdout, --validate-ipc CLI arguments
      exports: determine_ipc_mode function
    - path: veritas/core/ipc.py
      provides: IPC mode determination logic
      exports:
        - determine_ipc_mode
        - IPC_MODES enum or constants
  key_links:
    - from: veritas/__main__.py
      to: veritas/core/ipc.py
      via: from veritas.core.ipc import determine_ipc_mode
      pattern: from veritas\.core\.ipc import determine_ipc_mode
    - from: veritas/core/ipc.py
      to: os.environ
      via: os.getenv("QUEUE_IPC_MODE") and os.getenv("QUEUE_IPC_ROLLOUT")
      pattern: os\.getenv\("QUEUE_IPC_(MODE|ROLLOUT)"

---

<objective>
Add CLI flags and mode selection logic for dual-mode IPC with gradual rollout support per user decisions in CONTEXT.md.

Purpose: Enable control over IPC mode (Queue vs stdout) via CLI flags and environment variables with correct priority hierarchy.

Output: CLI arguments parsed in `veritas/__main__.py`, mode determination logic in `veritas/core/ipc.py`.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-ipc-communication-stabilization/01-CONTEXT.md
@.planning/phases/01-ipc-communication-stabilization/01-RESEARCH.md
@.planning/STATE.md
@.planning/ROADMAP.md

# Codebase references
@C:/files/coding dev era/elliot/elliotAI/veritas/__main__.py
@C:/files/coding dev era/elliot/elliotAI/veritas/core/ipc.py (created in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Add mode determination logic to ipc.py module</name>
  <files>veritas/core/ipc.py</files>
  <action>
    Extend `veritas/core/ipc.py` (created in Plan 01) with mode determination:

    1. Add mode constants at module level:
    ```python
    IPC_MODE_QUEUE = "queue"
    IPC_MODE_STDOUT = "stdout"
    IPC_MODE_VALIDATE = "validate"  # Run both and compare
    ```

    2. Add `determine_ipc_mode(
      cli_use_queue_ipc: bool = False,
      cli_use_stdout: bool = False,
      cli_validate_ipc: bool = False,
    ) -> str` function implementing priority hierarchy:
       a. If cli_validate_ipc is True → return IPC_MODE_VALIDATE
       b. If cli_use_queue_ipc is True → return IPC_MODE_QUEUE
       c. If cli_use_stdout is True → return IPC_MODE_STDOUT
       d. Check env var QUEUE_IPC_MODE:
          - If "queue" → return IPC_MODE_QUEUE
          - If "stdout" or "fallback" → return IPC_MODE_STDOUT
       e. Default: use percentage-based rollout
          - Read QUEUE_IPC_ROLLOUT env var (float 0.0-1.0, default 0.1)
          - Return IPC_MODE_QUEUE if random.random() < rollout_rate
          - Else return IPC_MODE_STDOUT

    3. Add `get_rollout_percentage() -> float` helper:
       - Read QUEUE_IPC_ROLLOUT env var
       - Parse as float, default 0.1 (10%)
       - Clamp to 0.0-1.0 range
       - Return float

    4. Import `random` module at top of file

    5. Add docstrings explaining the priority hierarchy per CONTEXT.md decisions

    DO NOT add actual Queue/Stdout execution - just return mode strings.
  </action>
  <verify>
    python -c "
import os
os.environ['QUEUE_IPC_MODE'] = 'queue'
from veritas.core.ipc import determine_ipc_mode, IPC_MODE_QUEUE
assert determine_ipc_mode() == IPC_MODE_QUEUE
print('OK')
"
  </verify>
  <done>
    Mode determination function returns correct mode strings based on CLI, environment, and default rollout percentage.
  </done>
</task>

<task type="auto">
  <name>Add CLI flags to veritas/__main__.py for IPC mode control</name>
  <files>veritas/__main__.py</files>
  <action>
    Modify `veritas/__main__.py` to add CLI flags:

    1. In the `parser.add_argument()` section, add three new flags BEFORE the existing arguments:
       ```python
       parser.add_argument(
           "--use-queue-ipc",
           action="store_true",
           help="Use multiprocessing.Queue for IPC instead of stdout parsing"
       )
       parser.add_argument(
           "--use-stdout",
           action="store_true",
           help="Force stdout mode (disable Queue IPC)"
       )
       parser.add_argument(
           "--validate-ipc",
           action="store_true",
           help="Run both Queue and stdout modes and compare results"
       )
       ```

    2. After `args = parser.parse_args()`, add IPC mode determination:
       ```python
       from veritas.core.ipc import determine_ipc_mode, IPC_MODE_QUEUE, create_queue, deserialize_queue_from_env

       # Determine IPC mode based on CLI, environment, and rollout
       ipc_mode = determine_ipc_mode(
           cli_use_queue_ipc=args.use_queue_ipc,
           cli_use_stdout=args.use_stdout,
           cli_validate_ipc=args.validate_ipc,
       )
       ```

    3. Add comment explaining mode priority: CLI > ENV > Default (10% rollout)

    4. For now, just assign ipc_mode variable - NOT using it yet (that's Plan 03)

    5. Keep existing args parsing logic intact (url, tier, report, json, etc.)

    DO NOT modify existing argument parsing or main() logic beyond adding IPC support.
  </action>
  <verify>
    python -m veritas https://example.com --help 2>&1 | grep -E "(use-queue-ipc|use-stdout|validate-ipc)"
  </verify>
  <done>
    CLI flags are present in --help output and parsed correctly without breaking existing functionality.
  </done>
</task>

</tasks>

<verification>
1. CLI flags --use-queue-ipc, --use-stdout, --validate-ipc are parsable
2. Mode determination follows priority: CLI > ENV > Default (10%)
3. Environment variables QUEUE_IPC_MODE and QUEUE_IPC_ROLLOUT are read
4. Default behavior uses 10% Queue mode percentage rollout
5. No existing functionality is broken
</verification>

<success_criteria>
1. CLI arguments added to veritas/__main__.py for IPC mode control
2. Mode determination logic added to veritas/core/ipc.py with correct priority
3. Environment variable support for QUEUE_IPC_MODE and QUEUE_IPC_ROLLOUT
4. Default 10% rollout when no explicit mode specified
5. Help output shows new IPC flags
</success_criteria>

<output>
After completion, create `.planning/phases/01-ipc-communication-stabilization/01-02-SUMMARY.md`
</output>
