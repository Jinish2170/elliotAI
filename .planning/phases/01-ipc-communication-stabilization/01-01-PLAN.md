---
phase: 01-ipc-communication-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - veritas/core/ipc.py
  - veritas/core/__init__.py
  - veritas/tests/test_ipc_queue.py
autonomous: true
requirements:
  - CORE-02
  - CORE-02-2
  - CORE-06

must_haves:
  truths:
    - ProgressEvent dataclass defines structured event schema for Queue messages
    - Queue can be serialized and reconstructed for subprocess environment
    - Windows spawn context is set for multiprocessing compatibility
    - Queue serialization test passes
  artifacts:
    - path: veritas/core/ipc.py
      provides: IPC utilities for Queue creation and serialization
      min_lines: 80
      exports:
        - ProgressEvent
        - create_queue
        - serialize_queue
        - deserialize_queue_from_env
    - path: veritas/tests/test_ipc_queue.py
      provides: Unit tests for Queue serialization and Windows compatibility
      min_lines: 60
      contains: test_queue serialization, test_windows_spawn_context
  key_links:
    - from: veritas/core/ipc.py
      to: multiprocessing.Manager
      via: mp.Manager().Queue()
      pattern: mp\.Manager\(\)\.Queue\(maxsize=\d+\)
    - from: veritas/core/ipc.py
      to: subprocess environment
      via: base64+b64encode(pickle.dumps())
      pattern: base64\.b64encode\(pickle\.dumps\(|pickle\.loads\(base64\.b64decode\(

---

<objective>
Create core IPC infrastructure with ProgressEvent dataclass and Queue serialization utilities for Windows + Python 3.14 subprocess communication.

Purpose: Establish foundation for Queue-based IPC with type-safe structured events and cross-process Queue passing via multiprocessing.Manager.

Output: `veritas/core/ipc.py` module with ProgressEvent, Queue creation, and serialization functions; unit tests in `veritas/tests/test_ipc_queue.py`.
</objective>

<execution_context>
@C:/Users/hp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/hp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-ipc-communication-stabilization/01-CONTEXT.md
@.planning/phases/01-ipc-communication-stabilization/01-RESEARCH.md
@.planning/STATE.md
@.planning/ROADMAP.md

# Codebase references
@C:/files/coding dev era/elliot/elliotAI/veritas/core/orchestrator.py
@C:/files/coding dev era/elliot/elliotAI/backend/services/audit_runner.py
@C:/files/coding dev era/elliot/elliotAI/veritas/__main__.py
@C:/files/coding dev era/elliot/elliotAI/veritas/tests/test_veritas.py
</context>

<tasks>

<task type="auto">
  <name>Create IPC module with ProgressEvent and Queue utilities</name>
  <files>veritas/core/ipc.py</files>
  <action>
    Create new file `veritas/core/ipc.py` with:

    1. Import statements: `dataclasses`, `multiprocessing`, `pickle`, `base64`, `queue`, `sys`, `time`, `typing`

    2. Configure spawn context at module level (REQUIRED for Windows):
    ```python
    if sys.platform == "win32":
        multiprocessing.set_start_method('spawn', force=True)
    ```

    3. `@dataclass` `ProgressEvent` class with fields:
       - `type: str` (event type: phase_start, phase_complete, finding, screenshot, etc.)
       - `phase: str = ""` (audit phase name)
       - `step: str = ""` (step within phase)
       - `pct: int = 0` (progress percentage)
       - `detail: str = ""` (human-readable detail)
       - `summary: dict = None` (optional summary dict)
       - `data: bytes = None` (binary data for screenshots)
       - `timestamp: float = field(default_factory=time.time)` (event timestamp)

    4. `create_queue(maxsize: int = 1000) -> multiprocessing.Queue` function that creates and returns a Manager.Queue with specified maxsize. Use `multiprocessing.Manager().Queue(maxsize=maxsize)`.

    5. `serialize_queue(queue: multiprocessing.Queue) -> tuple[str, str]` function that:
       - Uses `multiprocessing.reduction.reduce_connection(queue)[0]` to get pipeline handle
       - Base64-encodes pickled pipeline handle
       - Returns `(fileno, serialized)` tuple for environment passing

    6. `deserialize_queue_from_env() -> Optional[multiprocessing.Queue]` function that:
       - Reads `AUDIT_QUEUE_FD` and `AUDIT_QUEUE_KEY` from environment
       - Deserializes using `pickle.loads(base64.b64decode(...))`
       - Reconstructs using `multiprocessing.reduction.rebuild_connection()`
       - Returns Queue or None on error
       - Logs ERROR on failure

    DO NOT create any stdout parsing code - this is a clean Queue-only module entry point.
  </action>
  <verify>
    python -c "from veritas.core.ipc import ProgressEvent, create_queue, serialize_queue; print('OK')"
  </verify>
  <done>
    IPC module exists with ProgressEvent dataclass, Queue utilities, and all four functions importable without errors.
  </done>
</task>

<task type="auto">
  <name>Add unit tests for Queue serialization and Windows compatibility</name>
  <files>veritas/tests/test_ipc_queue.py</files>
  <action>
    Create new file `veritas/tests/test_ipc_queue.py` with tests:

    1. Import pytest, multiprocessing, ipc module

    2. `test_progress_event_creation()` test:
       - Create ProgressEvent instance with all fields
       - Verify fields are correctly set
       - Verify timestamp defaults to current time

    3. `test_queue_serialization()` test:
       - Create queue using `create_queue(maxsize=100)`
       - Put test dict into queue: `{"test": "data"}`
       - Serialize using `serialize_queue()`
       - Deserialize from serialized data
       - Verify reconstructed queue returns same data
       - This proves Queue can be passed to subprocess

    4. `test_queue_full_backpressure()` test:
       - Create queue with maxsize=5
       - Put 5 items successfully
       - Put 6th item with timeout=0.1, expect queue.Full exception
       - Verify backpressure handling works

    5. `test_deserialize_queue_from_env_missing_vars()` test:
       - Call `deserialize_queue_from_env()` without env vars set
       - Verify returns None (not crash)

    Use pytest fixtures, mock environment variables as needed. Follow existing test patterns from `veritas/tests/test_veritas.py`.
  </action>
  <verify>
    cd veritas && python -m pytest tests/test_ipc_queue.py -v
  </verify>
  <done>
    All unit tests pass (5/5 tests), confirming Queue serialization, Windows compatibility, and error handling work correctly.
  </done>
</task>

</tasks>

<verification>
1. ProgressEvent dataclass defines all required fields with proper types
2. Queue can be serialized/deserialized without data loss
3. Windows spawn context is set at module import
4. Unit tests cover serialization, backpressure, and error cases
5. Module imports cleanly without errors
</verification>

<success_criteria>
1. `veritas/core/ipc.py` module created with ProgressEvent and Queue utilities
2. `veritas/tests/test_ipc_queue.py` created with 5 passing unit tests
3. Queue serialization test proves cross-process passing works
4. Windows spawn context configured for platform compatibility
5. Module can be imported and used without dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-ipc-communication-stabilization/01-01-SUMMARY.md`
</output>
