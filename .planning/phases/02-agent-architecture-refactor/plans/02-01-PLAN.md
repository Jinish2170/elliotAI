---
phase: 02-agent-architecture-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - veritas/agents/security_agent.py
  - veritas/agents/__init__.py
  - veritas/core/types.py
  - veritas/core/__init__.py
  - veritas/config/settings.py
autonomous: true
requirements:
  - CORE-01
  - CORE-01-2
must_haves:
  truths:
    - "User can import SecurityAgent class from veritas.agents"
    - "User can import SecurityResult, SecurityFinding, SecurityConfig, Severity from veritas.core"
    - "SecurityAgent constructor accepts NIMClient and returns valid instance"
    - "SecurityAgent.analyze(url) returns SecurityResult dataclass"
    - "async with SecurityAgent() context manager pattern works"
    - "SecurityResult.to_dict() and from_dict() enable JSON serialization"
    - "security_node function continues to work unchanged"
  artifacts:
    - path: "veritas/agents/security_agent.py"
      provides: "SecurityAgent class skeleton with async analyze()"
      contains: "class SecurityAgent"
      min_lines: 50
    - path: "veritas/core/types.py"
      provides: "Security agent data structures"
      contains: ["Severity", "SecurityFinding", "SecurityConfig", "SecurityResult"]
      min_lines: 50
    - path: "veritas/config/settings.py"
      provides: "SecurityAgent configuration settings"
      contains: ["SECURITY_AGENT_TIMEOUT", "SECURITY_AGENT_RETRY_COUNT", "SECURITY_AGENT_FAIL_FAST"]
  key_links:
    - from: "veritas/agents/security_agent.py"
      to: "veritas/core/types.py"
      via: "import SecurityResult, SecurityConfig, Severity"
      pattern: "from core.types import"
    - from: "veritas/agents/security_agent.py"
      to: "veritas/config/settings.py"
      via: "import SECURITY_AGENT_* settings"
      pattern: "from config.settings import"
    - from: "veritas/agents/__init__.py"
      to: "veritas/agents/security_agent.py"
      via: "export SecurityAgent"
      pattern: "from .security_agent import SecurityAgent"
    - from: "veritas/core/__init__.py"
      to: "veritas/core/types.py"
      via: "export SecurityResult, SecurityFinding, SecurityConfig, Severity"
      pattern: "import.*SecurityResult"
---

# Phase 2 Plan 01: SecurityAgent Data Structures and Class Skeleton

**Wave:** 1 (Foundation)
**Depends on:** Phase 1 Complete
**Autonomous:** true

## Tasks

### Task: Create SecurityAgent core data structures
Create `veritas/core/types.py` with:

1. **Severity enum** - Literal type for security finding severity: "CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO"
2. **SecurityFinding dataclass** with fields:
   - category: str (e.g., "security_headers", "phishing", "redirects", "js_analysis", "forms")
   - severity: Severity (enum)
   - evidence: str
   - source_module: str (name of module that generated this finding)
   - timestamp: str (ISO format)
   - confidence: float (0-1)
3. **SecurityConfig dataclass** with fields:
   - timeout: int = 15 (seconds per module)
   - retry_count: int = 2
   - fail_fast: bool = False (if True, stop on first module failure)
4. **SecurityResult dataclass** with fields:
   - url: str
   - audit_id: str (optional, for tracking)
   - timestamp: str (ISO format)
   - composite_score: float (0-1, aggregated from all modules)
   - findings: list[SecurityFinding]
   - modules_results: dict[str, any] (nested per-module results: {"security_headers": {...}, "phishing": {...}})
   - modules_run: list[str] (list of module names that were executed)
   - modules_failed: list[str] (list of module names that failed)
   - errors: list[str] (error messages captured during analysis)
   - analysis_time_ms: int
   - methods:
     - to_dict() -> dict (JSON serialization)
     - from_dict(dict) -> SecurityResult (JSON deserialization)
     - add_finding(finding: SecurityFinding) -> None
     - add_error(error: str) -> None

### Task: Create SecurityAgent class skeleton
Create `veritas/agents/security_agent.py` with:

1. **Class structure matching VisionAgent/JudgeAgent pattern:**
   - `__init__(nim_client: Optional[NIMClient] = None, config: Optional[SecurityConfig] = None)`
   - Store nim_client as `self._nim` instance state
   - Store config as `self._config` instance state
   - Initialize empty `self._discovered_modules: dict[str, type]` for auto-discovery

2. **Async context manager support:**
   - `async def __aenter__(self) -> SecurityAgent: ...`
   - `async def __aexit__(self, exc_type, exc_val, exc_tb) -> None: ...`

3. **Class-level module discovery methods** (skeleton):
   - `_discover_modules() -> dict[str, type]` - to be filled in plan 02
   - Module storage using `self._discovered_modules`

4. **Async analyze() method stub**
   - `async def analyze(self, url: str) -> SecurityResult:`
   - Initialize result with url, timestamp
   - Populate empty modules_results dict
   - Return result with score=1.0 (no modules run yet)
   - Log "SecurityAgent.analyze called with USE_SECURITY_AGENT={env_value}"

### Task: Update configuration
Modify `veritas/config/settings.py`:

1. Add SecurityAgent configuration section:
   - SECURITY_AGENT_TIMEOUT = 15
   - SECURITY_AGENT_RETRY_COUNT = 2
   - SECURITY_AGENT_FAIL_FAST = False

2. Add feature flag (but default True per user decision):
   - USE_SECURITY_AGENT: bool = os.getenv("USE_SECURITY_AGENT", "true").lower() == "true"
   - SECURITY_AGENT_ROLLOUT: float = float(os.getenv("SECURITY_AGENT_ROLLOUT", "1.0"))  # 0.0 to 1.0

### Task: Update imports
Modify `veritas/agents/__init__.py` and `veritas/core/__init__.py`:

1. Export SecurityAgent class
2. Export SecurityResult, SecurityFinding, SecurityConfig, Severity

## Verification Criteria

```python
# Can import all new types
from agents.security_agent import SecurityAgent
from core.types import SecurityResult, SecurityFinding, Severity, SecurityConfig

# Can create agent with NIMClient
agent = SecurityAgent(nim_client=mock_nim)
assert agent._nim == mock_nim

# Can use async context manager
async with SecurityAgent() as agent:
    assert agent is not None

# Can analyze (returns empty result for now)
result = await agent.analyze("https://example.com")
assert isinstance(result, SecurityResult)
assert result.url == "https://example.com"
assert result.composite_score == 1.0
assert result.modules_run == []

# SecurityResult can be serialized
d = result.to_dict()
assert "url" in d
assert "findings" in d
assert "modules_results" in d

# Can deserialize
result2 = SecurityResult.from_dict(d)
assert result2.url == result.url
```

## Notes
- This is the foundational plan - only creates data structures and class skeleton
- Module auto-discovery and actual analysis logic implemented in plan 02-02
- Feature-flagged migration implemented in plan 02-03
- Tests added in plan 02-04
- Integration tests added in plan 02-05
