---
phase: 02-agent-architecture-refactor
plan: 04
type: execute
wave: 3
depends_on:
  - "02-01-PLAN.md"
  - "02-02-PLAN.md"
  - "02-03-PLAN.md"
files_modified:
  - veritas/tests/test_security_agent.py
  - veritas/tests/test_security_dataclasses.py
  - veritas/tests/__init__.py
autonomous: true
requirements:
  - CORE-06-2
must_haves:
  truths:
    - "Test file test_security_agent.py exists with at least 20 test methods"
    - "Test file test_security_dataclasses.py exists with at least 10 test methods"
    - "All SecurityAgent unit tests pass when run with pytest"
    - "Tests follow same pattern as VisionAgent/JudgeAgent tests"
    - "Tests use mocks to avoid real network calls"
    - "Tests cover both success and error cases"
    - "All baseline tests still pass (60/60 Python tests + 40 IPC tests)"
  artifacts:
    - path: "veritas/tests/test_security_agent.py"
      provides: "SecurityAgent unit tests"
      contains: ["TestSecurityAgentInit", "TestSecurityAgentModuleDiscovery", "TestSecurityAgentAnalyze"]
      min_lines: 150
    - path: "veritas/tests/test_security_dataclasses.py"
      provides: "SecurityResult serialization tests"
      contains: ["TestSecurityResultSerialization", "TestSecurityFindingStructure", "TestSecurityConfigDefaults"]
      min_lines: 80
  key_links:
    - from: "veritas/tests/test_security_agent.py"
      to: "veritas/agents/security_agent.py"
      via: "import SecurityAgent for testing"
      pattern: "from agents.security_agent import SecurityAgent"
    - from: "veritas/tests/test_security_agent.py"
      to: "veritas/core/types.py"
      via: "import dataclasses for testing"
      pattern: "from core.types import"
    - from: "veritas/tests/test_security_dataclasses.py"
      to: "veritas/core/types.py"
      via: "import SecurityResult, SecurityFinding, SecurityConfig for testing"
      pattern: "from core.types import"
---

# Phase 2 Plan 04: SecurityAgent Unit Tests

**Wave:** 3 (Testing)
**Depends on:** 02-01-PLAN.md, 02-02-PLAN.md, 02-03-PLAN.md
**Autonomous:** true

## Tasks

### Task: Create SecurityAgent unit tests
Create `veritas/tests/test_security_agent.py` with test classes:

1. **Test class: TestSecurityAgentInit**
   - test_init_with_nim_client()
   - test_init_without_nim_client_creates_default()
   - test_init_with_config()
   - test_init_without_config_uses_defaults()
   - test_async_context_manager()

2. **Test class: TestSecurityAgentModuleDiscovery**
   - test_discover_modules_finds_all_five_modules()
   - test_discover_modules_maps_correct_names()
   - test_dynamic_methods_created_analysis()
   - test_dynamic_methods_created_check()
   - test_dynamic_methods_created_validate()

3. **Test class: TestSecurityAgentAnalyze**
   - test_analyze_with_url_returns_security_result()
   - test_analyze_runs_all_modules()
   - test_analyze_populates_modules_results()
   - test_analyze_aggregates_findings()
   - test_analyze_calculates_composite_score()
   - test_analyze_with_page_passes_to_modules()
   - test_analyze_fail_fast_stops_on_first_error()
   - test_analyze_records_module_execution_time()

4. **Test class: TestSecurityAgentAutoFallback**
   - test_analyze_exception_falls_back_to_function()
   - test_analyze_exception_logs_error_before_fallback()
   - test_analyze_exception_marks_mode_as_function_fallback()

5. **Test class: TestSecurityAgentModeSelection**
   - test_is_enabled_with_true_env_var()
   - test_is_enabled_with_false_env_var()
   - test_is_enabled_with_auto_env_var_rollout()
   - test_is_enabled_consistent_hash_same_url_same_result()
   - test_is_enabled_consistent_hash_different_url_different_result()
   - test_get_env_mode_interprets_strings_correctly()

6. **Test class: TestSecurityAgentDynamicMethods**
   - test_analyze_headers_callable()
   - test_check_phishing_callable()
   - test_analyze_redirects_callable()
   - test_analyze_js_callable()
   - test_validate_forms_callable()

### Task: Create SecurityResult dataclass tests
Create `veritas/tests/test_security_dataclasses.py` with test classes:

1. **Test class: TestSecurityResultSerialization**
   - test_to_dict_returns_dict()
   - test_to_dict_includes_all_fields()
   - test_from_dict_reconstructs_result()
   - test_findings_serializable()
   - test_modules_results_serializable()

2. **Test class: TestSecurityFindingStructure**
   - test_securityfinding_has_all_required_fields()
   - test_severity_enum_values()
   - test_securityfinding_timestamp_format()

3. **Test class: TestSecurityConfigDefaults**
   - test_securityconfig_has_default_timeout()
   - test_securityconfig_has_default_retry_count()
   - test_securityconfig_has_default_fail_fast()

4. **Test class: TestSecurityResultAggregation**
   - test_add_finding_appends_to_list()
   - test_add_error_appends_to_list()
   - test_composite_score_calculation_weights()
   - test_composite_score_normalised_to_range()

### Task: Create fixtures and mocks
Add test fixtures in `test_security_agent.py`:

1. `mock_nim_client` - mock NIMClient with basic return values
2. `mock_page` - mock Playwright Page object for JS/form modules
3. `mock_settings` - mock settings with SecurityAgent config
4. `mock_module_result` - helper to create mock module results
5. `sample_security_result` - pre-built SecurityResult for testing

## Test Structure (Following VisionAgent/JudgeAgent Pattern)

```python
# test_security_agent.py
import pytest
from unittest.mock import Mock, AsyncMock, patch
from agents.security_agent import SecurityAgent
from core.types import SecurityResult, SecurityFinding, Severity, SecurityConfig

class TestSecurityAgentInit:
    """Test SecurityAgent initialization."""

    async def test_init_with_nim_client(self, mock_nim_client):
        agent = SecurityAgent(nim_client=mock_nim_client)
        assert agent._nim == mock_nim_client

    async def test_init_without_nim_client_creates_default(self):
        agent = SecurityAgent()
        assert agent._nim is not None

    async def test_init_with_config(self):
        config = SecurityConfig(timeout=30, retry_count=3, fail_fast=True)
        agent = SecurityAgent(config=config)
        assert agent._config.timeout == 30
        assert agent._config.retry_count == 3
        assert agent._config.fail_fast is True

    async def test_async_context_manager(self):
        async with SecurityAgent() as agent:
            assert agent is not None
            assert len(agent._discovered_modules) > 0

# Similar test classes for other functionality...

class TestSecurityAgentAnalyze:
    """Test SecurityAgent.analyze() method."""

    async def test_analyze_with_url_returns_security_result(self, mock_nim_client):
        agent = SecurityAgent(nim_client=mock_nim_client)
        result = await agent.analyze("https://example.com")
        assert isinstance(result, SecurityResult)
        assert result.url == "https://example.com"

    # ... more tests
```

## Verification Criteria

```bash
cd veritas
python -m pytest tests/test_security_agent.py -v
# All tests pass

python -m pytest tests/test_security_dataclasses.py -v
# All tests pass

python -m pytest tests/ -v
# All 110 tests pass (60 baseline + 40 IPC + 10 security_agent dataclasses + 20 security_agent)
```

## Notes
- Follow same test pattern as VisionAgent/JudgeAgent (mock NIMClient, async tests)
- Tests should work without network calls (mock all external dependencies)
- Tests should work without Playwright (mock Page object)
- Tests should be deterministic (no random data, fixed URLs)
- Test execution time measured to ensure not too slow
- Edge cases tested: empty URL, invalid URL, network errors, module failures
