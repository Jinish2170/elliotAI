---
phase: 02-agent-architecture-refactor
plan: 05
type: execute
wave: 3
depends_on:
  - "02-01-PLAN.md"
  - "02-02-PLAN.md"
  - "02-03-PLAN.md"
  - "02-04-PLAN.md"
files_modified:
  - veritas/tests/test_security_integration.py
  - veritas/tests/test_migration_path.py
autonomous: true
requirements:
  - CORE-01
  - CORE-01-4
must_haves:
  truths:
    - "Test file test_security_integration.py exists with at least 15 test methods"
    - "Test file test_migration_path.py exists with at least 15 test methods"
    - "All integration tests pass or skip appropriately"
    - "Tests marked with @pytest.mark.integration can be run separately"
    - "Tests marked with @pytest.mark.slow can be run separately"
    - "Real modules tested produce correct SecurityFinding objects"
    - "Orchestrator routing works correctly for both agent and function modes"
    - "Feature flag routing verified (true/false/auto)"
    - "Staged rollout verified (0%, 50%, 100%)"
    - "Auto-fallback verified and tested"
    - "All tests pass (60 baseline + 40 IPC + 30 security_agent = 130 total)"
  artifacts:
    - path: "veritas/tests/test_security_integration.py"
      provides: "SecurityAgent integration tests"
      contains: ["TestSecurityAgentRealModules", "TestSecurityAgentWithOrchestrator", "TestSecurityModuleEndToEnd"]
      min_lines: 120
    - path: "veritas/tests/test_migration_path.py"
      provides: "Migration path verification tests"
      contains: ["TestFeatureFlagRouting", "TestAutoFallback", "TestBackwardCompatibility", "TestStagedRollout"]
      min_lines: 100
  key_links:
    - from: "veritas/tests/test_security_integration.py"
      to: "veritas/agents/security_agent.py"
      via: "real module integration testing"
      pattern: "from agents.security_agent import SecurityAgent"
    - from: "veritas/tests/test_security_integration.py"
      to: "veritas/core/orchestrator.py"
      via: "orchestrator routing tests"
      pattern: "from core.orchestrator import"
    - from: "veritas/tests/test_migration_path.py"
      to: "veritas/core/orchestrator.py"
      via: "feature flag routing tests"
      pattern: "security_node_with_agent"
    - from: "veritas/tests/test_migration_path.py"
      to: "veritas/core/ipc.py"
      via: "progress event verification"
      pattern: "ProgressEvent|SecurityMode"
---

# Phase 2 Plan 05: SecurityAgent Integration Tests and Migration Verification

**Wave:** 3 (Testing)
**Depends on:** 02-01-PLAN.md, 02-02-PLAN.md, 02-03-PLAN.md, 02-04-PLAN.md
**Autonomous:** true

## Tasks

### Task: Create SecurityAgent integration tests
Create `veritas/tests/test_security_integration.py` with test classes:

1. **Test class: TestSecurityAgentRealModules**
   - Use real analysis modules (no mocking) but with test URLs
   - test_analyze_with_real_security_headers_module()
   - test_analyze_with_real_phishing_checker_module()
   - test_analyze_with_real_redirect_analyzer_module()
   - test_analyze_aggregates_all_real_modules()
   - test_composite_score_with_real_module_results()

2. **Test class: TestSecurityAgentWithOrchestrator**
   - Test SecurityAgent works within actual orchestrator flow
   - test_security_node_with_agent_routes_to_agent()
   - test_security_node_with_agent_routes_to_function()
   - test_security_node_with_agent_auto_fallback()
   - test_orchestrator_emits_security_mode_events()

3. **Test class: TestSecurityModuleEndToEnd**
   - Test each module produces correct SecurityFinding objects
   - test_security_headers_produces_findings()
   - test_phishing_checker_produces_findings()
   - test_redirect_analyzer_produces_findings()
   - test_js_analyzer_produces_findings()
   - test_form_validator_produces_findings()

4. **Test class: TestSecurityAgentWithProgressEvents**
   - Test ProgressEvent integration for security analysis
   - test_security_mode_started_event_emitted()
   - test_security_mode_completed_event_emitted()
   - test_events_includes_mode_and_metrics()
   - test_queue_ipc_receives_security_events()

### Task: Create migration path tests
Create `veritas/tests/test_migration_path.py` with test classes:

1. **Test class: TestFeatureFlagRouting**
   - test_use_security_agent_true_uses_agent()
   - test_use_security_agent_false_uses_function()
   - test_security_agent_rollout_consistent_routing()
   - test_same_url_always_same_mode()
   - test_different_urls_distribute_correctly()

2. **Test class: TestAutoFallback**
   - test_agent_error_falls_back_to_function()
   - test_fallback_logs_function_mode_used()
   - test_fallback_still_returns_security_results()
   - test_multiple_agent_errors_each_fall_back()

3. **Test class: TestBackwardCompatibility**
   - test_security_node_function_still_works()
   - test_security_node_function_returns_same_structure()
   - test_orchestrator_works_with_both_modes()
   - test_rolling_back_to_function_mode_works()

4. **Test class: TestModeTracking**
   - test_security_mode_field_set_in_state()
   - test_security_mode_logged_in_events()
   - test_function_fallback_mode_tracked_correctly()

5. **Test class: TestStagedRollout**
   - test_rollout_0_percent_all_function()
   - test_rollout_50_percent_splits_equally()
   - test_rollout_100_percent_all_agent()
   - test_rollout_deterministic_same_url_same_result()

### Task: Add integration test fixtures
Add test fixtures in `test_security_integration.py` and `test_migration_path.py`:

1. `test_http_server` - fixture to serve test HTML pages
2. `https_test_url` - local HTTPS URL for module testing
3. `mock_playwright_context` - fixture for Playwright testing
4. `test_sites_dir` - path to test HTML sites (existing)

## Integration Test Structure

```python
# test_security_integration.py
import pytest
import asyncio
from unittest.mock import patch, AsyncMock
from agents.security_agent import SecurityAgent
from core.ipc import ProgressEvent, SecurityModeStarted, SecurityModeCompleted

class TestSecurityAgentRealModules:
    """Integration tests with real analysis modules."""

    @pytest.mark.integration
    @pytest.mark.slow
    async def test_analyze_with_real_security_headers_module(self):
        """Test real security_headers module produces results."""
        agent = SecurityAgent()

        # Use a real URL that should have headers
        result = await agent.analyze("https://httpbin.org/headers")

        assert result.composite_score is not None
        assert "security_headers" in result.modules_results
        assert len(result.findings) >= 0

    # ... more real module tests

class TestSecurityAgentWithOrchestrator:
    """Test SecurityAgent works within orchestrator flow."""

    @pytest.mark.integration
    async def test_security_node_with_agent_routes_to_agent(self):
        """Test orchestrator routes to SecurityAgent when enabled."""
        import os
        os.environ["USE_SECURITY_AGENT"] = "true"

        from core.orchestrator import security_node_with_agent

        state = {"url": "https://example.com"}
        result = await security_node_with_agent(state)

        assert "security_results" in result
        assert result["security_results"].get("security_mode") == "agent"

    # ... more orchestrator tests
```

## Migration Path Test Structure

```python
# test_migration_path.py
import os
import pytest
from core.orchestrator import security_node, security_node_with_agent
from agents.security_agent import SecurityAgent

class TestFeatureFlagRouting:
    """Test feature flag routing between agent and function."""

    @pytest.mark.integration
    async def test_use_security_agent_true_uses_agent(self):
        """Test USE_SECURITY_AGENT=true routes to SecurityAgent."""
        os.environ["USE_SECURITY_AGENT"] = "true"

        state = {"url": "https://httpbin.org/headers"}
        result = await security_node_with_agent(state)

        assert result["security_results"]["security_mode"] == "agent"

    async def test_use_security_agent_false_uses_function(self):
        """Test USE_SECURITY_AGENT=false routes to security_node function."""
        os.environ["USE_SECURITY_AGENT"] = "false"

        state = {"url": "https://httpbin.org/headers"}
        result = await security_node_with_agent(state)

        assert result["security_results"]["security_mode"] == "function"

    async def test_security_agent_rollout_consistent_routing(self):
        """Test consistent hash routing for percentage rollout."""
        os.environ["USE_SECURITY_AGENT"] = "auto"
        os.environ["SECURITY_AGENT_ROLLOUT"] = "0.5"

        url = "https://test-url-for-hash.com"
        result1 = await security_node_with_agent({"url": url})
        result2 = await security_node_with_agent({"url": url})

        # Same URL should always get same mode
        mode1 = result1["security_results"]["security_mode"]
        mode2 = result2["security_results"]["security_mode"]
        assert mode1 == mode2, f"Same URL got different modes: {mode1} vs {mode2}"

    # ... more feature flag tests
```

## Verification Criteria

```bash
# Run all tests
cd veritas
python -m pytest tests/ -v
# All 130 tests pass

# Run only integration tests
python -m pytest tests/ -m integration -v
# All integration tests pass

# Run only security migration tests
python -m pytest tests/test_migration_path.py -v
# All 15 migration tests pass

# Run only agent mode (should use SecurityAgent)
USE_SECURITY_AGENT=true python -m pytest tests/test_migration_path.py -v
# All tests pass, mode="agent" in results

# Run only function mode (should use security_node)
USE_SECURITY_AGENT=false python -m pytest tests/test_migration_path.py -v
# All tests pass, mode="function" in results

# Run with 50% rollout
USE_SECURITY_AGENT=auto SECURITY_AGENT_ROLLOUT=0.5 python -m pytest tests/test_migration_path.py::TestFeatureFlagRouting -v
# Consistent routing verified
```

## Notes
- Integration tests are slower than unit tests (network calls, real modules)
- Use `@pytest.mark.integration` and `@pytest.mark.slow` markers
- Provide HTTPS URLs for real module testing (httpbin.org, example.com)
- Auto-fallback tested by forcing agent to throw exception
- Consistent hash routing verified by testing same URL multiple times
- Backward compatibility verified by running security_node independently
- Rollback verified by switching environment variable and re-running tests
- Mode tracking verified by checking security_mode field and events
